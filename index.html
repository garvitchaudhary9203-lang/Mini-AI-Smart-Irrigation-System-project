<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hydro-AI:SIS</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M12 3v18M12 3c-1.105 0-2 .895-2 2s.895 2 2 2h0c1.105 0 2-.895 2-2s-.895-2-2-2zM4 14h16m-8 0a4 4 0 100-8 4 4 0 000 8z'/%3E%3C/svg%3E" type="image/svg+xml">
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase Libraries -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged, signOut, signInWithEmailAndPassword, createUserWithEmailAndPassword, sendPasswordResetEmail, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Firestore is needed for persistent storage. Using a hardcoded app ID for demonstration.
        // In a real app, these values would be provided by the environment.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = {
            apiKey: "AIzaSyCvKwpHAvcu9QSJDjqf_zdiTSGDpdNrJbw",
            authDomain: "mini-ai-irrigation-system.firebaseapp.com",
            projectId: "mini-ai-irrigation-system",
            storageBucket: "mini-ai-irrigation-system.firebasestorage.app",
            messagingSenderId: "205361105789",
            appId: "1:205361105789:web:4c75a11eab0f8263265a14",
            measurementId: "G-KM4XGDFSDR"
        };
        const apiKey = "AIzaSyCJ_GWFHwPvDAJWTfwYYrmbh4MIylx5_lA"; // Keep this blank. It will be provided by the system.
const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? initialAuthToken : null;
        
        let db;
        let auth;
        let userId;
        let sensorData = {
            'zone1': { moisture: 0, temperature: 0, humidity: 0, crop: 'Lavender' },
            'zone2': { moisture: 0, temperature: 0, humidity: 0, crop: 'Zoysia Grass' },
            'zone3': { moisture: 0, temperature: 0, humidity: 0, crop: 'Tomatoes' },
            'zone4': { moisture: 0, temperature: 0, humidity: 0, crop: 'Apple Trees' }
        };
        let currentWeatherData = { temperature: 25, humidity: 65, condition: "Partly Cloudy" };
        let isPumpOn = false;
        let activeZone = 'zone1';

        setLogLevel('debug');

        const crops = {
            'Lavender': {
                photo: 'https://placehold.co/200x200/4c3b53/f3e8ff?text=Lavender',
                description: 'A drought-tolerant perennial that thrives in full sun and well-drained soil. Requires minimal watering once established.'
            },
            'Zoysia Grass': {
                photo: 'https://placehold.co/200x200/526d3d/d2ffc0?text=Zoysia+Grass',
                description: 'A warm-season grass known for its durability and drought resistance. It requires less water than other common lawn types.'
            },
            'Tomatoes': {
                photo: 'https://placehold.co/200x200/c72c1c/fff5e0?text=Tomatoes',
                description: 'A heat-loving vegetable that requires consistent moisture to prevent cracking and blossom-end rot. Needs more frequent watering.'
            },
            'Apple Trees': {
                photo: 'https://placehold.co/200x200/942b00/d9b48f?text=Apple+Trees',
                description: 'Established trees have deep roots and require less frequent but deep watering. Proper irrigation is crucial for fruit development.'
            }
        };

        async function initFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        const formattedUid = `${userId.substring(0, 4)}-${Math.floor(Math.random() * 9000) + 1000}-!@#*`;
                        document.getElementById('userIdDisplay').textContent = `User: ${formattedUid}`;
                        document.getElementById('authContainer').classList.add('hidden');
                        document.getElementById('appContainer').classList.remove('hidden');

                        const userDocRef = doc(db, `/artifacts/${appId}/users/${userId}/data/settings`);
                        const userDocSnap = await getDoc(userDocRef);
                        if (!userDocSnap.exists()) {
                            await setDoc(userDocRef, {
                                pumpStatus: "off",
                                aiMode: true,
                                lastManualOverride: null,
                            });
                        }
                        setupRealtimeListeners();
                        startSimulation();
                    } else {
                        document.getElementById('appContainer').classList.add('hidden');
                        document.getElementById('authContainer').classList.remove('hidden');
                        updateAuthView('login');
                        if (!initialAuthToken) {
                            signInAnonymously(auth);
                        }
                    }
                });

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    // This will be handled by onAuthStateChanged
                }

            } catch (error) {
                console.error("Error initializing Firebase:", error);
                document.getElementById('statusMessage').textContent = "Error: Could not connect to database. See console for details.";
            }
        }
        
        async function setupRealtimeListeners() {
            const settingsDocRef = doc(db, `/artifacts/${appId}/users/${userId}/data/settings`);
            onSnapshot(settingsDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    updatePumpStatus(data.pumpStatus === "on");
                    updateAiMode(data.aiMode);
                }
            }, (error) => {
                console.error("Error listening to settings:", error);
            });

            const sensorCollectionRef = collection(db, `/artifacts/${appId}/users/${userId}/data/sensors`);
            const q = query(sensorCollectionRef);
            onSnapshot(q, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === "added" || change.type === "modified") {
                        const sensorData = change.doc.data();
                        const zoneId = change.doc.id;
                        if (sensorData.moisture && sensorData.temperature && sensorData.humidity) {
                            sensorData.moisture = sensorData.moisture > 100 ? 100 : sensorData.moisture;
                            sensorData.temperature = sensorData.temperature > 40 ? 40 : sensorData.temperature;
                            sensorData.humidity = sensorData.humidity > 100 ? 100 : sensorData.humidity;
                            sensorData.moisture = sensorData.moisture < 0 ? 0 : sensorData.moisture;
                            sensorData.temperature = sensorData.temperature < -10 ? -10 : sensorData.temperature;
                            sensorData.humidity = sensorData.humidity < 0 ? 0 : sensorData.humidity;
                        }
                        sensorData[zoneId] = { ...sensorData[zoneId], ...sensorData };
                        updateSensorReadings(zoneId, sensorData);
                        simulateAiLogic(); 
                        updateDiagnostics();
                    }
                });
            }, (error) => {
                console.error("Error listening to sensors:", error);
            });
        }

        async function savePumpStatus(status){
    if (!db || !userId) {
        console.error("Database not initialized or user not logged in.");
        return;
    }
    const settingsDocRef = doc(db, `/artifacts/${appId}/users/${userId}/data/settings`);
    try {
        isPumpOn = (status === "on");
        await setDoc(settingsDocRef, { pumpStatus: status, lastManualOverride: serverTimestamp() }, { merge: true });
        // The real-time listener will update the UI, so no need for showMessage here.
    } catch (e) {
        console.error("Error updating pump status:", e);
    }
}

        async function saveAiMode(mode) {
            if (!db || !userId) return console.error("Database not initialized or user not logged in.");
            const settingsDocRef = doc(db, `/artifacts/${appId}/users/${userId}/data/settings`);
            try {
                await setDoc(settingsDocRef, { aiMode: mode }, { merge: true });
                showMessage(`AI Mode ${mode ? 'Enabled' : 'Disabled'}.`, "success");
            } catch (e) {
                console.error("Error updating AI mode:", e);
                showMessage("Failed to update AI mode.", "error");
            }
        }
        
        function updatePumpStatus(isOn) {
            isPumpOn = isOn;
            const pumpStatusText = document.getElementById('pumpStatusText');
            const pumpButton = document.getElementById('pumpControlButton');
            const pumpIndicator = document.getElementById('pumpIndicator');
            const systemStatus = document.getElementById('systemStatus');
            if (isOn) {
                pumpStatusText.textContent = "ON";
                pumpButton.textContent = "STOP PUMP";
                pumpButton.classList.remove('bg-green-600', 'hover:bg-green-700');
                pumpButton.classList.add('bg-red-600', 'hover:bg-red-700');
                pumpIndicator.classList.remove('bg-red-500', 'animate-pulse');
                pumpIndicator.classList.add('bg-green-500');
                systemStatus.textContent = "Watering Active";
            } else {
                pumpStatusText.textContent = "OFF";
                pumpButton.textContent = "START PUMP";
                pumpButton.classList.remove('bg-red-600', 'hover:bg-red-700');
                pumpButton.classList.add('bg-green-600', 'hover:bg-green-700');
                pumpIndicator.classList.remove('bg-green-500');
                pumpIndicator.classList.add('bg-red-500', 'animate-pulse');
                systemStatus.textContent = "All Zones OK";
            }
        }

        function updateAiMode(isAiMode) {
            const aiModeToggle = document.getElementById('aiModeToggle');
            const manualControls = document.getElementById('manualControls');
            aiModeToggle.checked = isAiMode;
            if (isAiMode) {
                manualControls.classList.add('hidden');
                document.getElementById('aiRecommendations').classList.remove('hidden');
            } else {
                manualControls.classList.remove('hidden');
                document.getElementById('aiRecommendations').classList.add('hidden');
            }
        }

        function updateSensorReadings(zoneId, data) {
            sensorData[zoneId] = data;

            const moistureCard = document.getElementById(`${zoneId}-moisture-card`);
            if (moistureCard) {
                const moistureValue = moistureCard.querySelector('.moisture-value');
                const moistureBar = moistureCard.querySelector('.moisture-bar');
                moistureValue.textContent = `${data.moisture}%`;
                moistureBar.style.width = `${data.moisture}%`;
                
                moistureBar.classList.remove('bg-green-500', 'bg-yellow-500', 'bg-red-500');
                if (data.moisture > 60) moistureBar.classList.add('bg-green-500');
                else if (data.moisture > 30) moistureBar.classList.add('bg-yellow-500');
                else moistureBar.classList.add('bg-red-500');

                const statusIndicator = moistureCard.querySelector('.status-indicator');
                statusIndicator.classList.remove('bg-green-500', 'bg-yellow-500', 'bg-red-500', 'animate-pulse');
                if (data.moisture > 60) statusIndicator.classList.add('bg-green-500', 'animate-pulse');
                else if (data.moisture > 30) statusIndicator.classList.add('bg-yellow-500');
                else statusIndicator.classList.add('bg-red-500');
            }

            if (zoneId === activeZone) {
                document.getElementById('moistureValue').textContent = `${data.moisture}%`;
                document.getElementById('moistureBar').style.width = `${data.moisture}%`;
                document.getElementById('moistureBar').className = `h-full rounded-full ${data.moisture > 60 ? 'bg-green-500' : data.moisture > 30 ? 'bg-yellow-500' : 'bg-red-500'}`;
                document.getElementById('tempValue').textContent = `${data.temperature}째C`;
                document.getElementById('humidityValue').textContent = `${data.humidity}%`;
            }
        }

        function updateWeatherData() {
            const conditions = ["Sunny", "Partly Cloudy", "Rain Expected", "Overcast"];
            const randomCondition = conditions[Math.floor(Math.random() * conditions.length)];
            const randomTemp = Math.floor(Math.random() * 10) + 20; 
            const randomHumid = Math.floor(Math.random() * 20) + 50; 
            currentWeatherData = {
                temperature: randomTemp,
                humidity: randomHumid,
                condition: randomCondition
            };
            document.getElementById('currentWeatherCondition').textContent = currentWeatherData.condition;
            document.getElementById('currentTemperature').textContent = `${currentWeatherData.temperature}째C`;
            document.getElementById('currentHumidity').textContent = `${currentWeatherData.humidity}% Humidity`;
        }
        
        // Simulates an AI model that updates the crops based on zone ID
        function updateCropsAndCropsInfo() {
            const cropsContainer = document.getElementById('cropsContainer');
            cropsContainer.innerHTML = '';
            
            const aiCrops = {
                'zone1': {
                    photo: 'https://placehold.co/200x200/4c3b53/f3e8ff?text=Lavender',
                    description: 'The AI has identified this zone for drought-tolerant perennials. These plants thrive with minimal watering.'
                },
                'zone2': {
                    photo: 'https://placehold.co/200x200/526d3d/d2ffc0?text=Zoysia+Grass',
                    description: 'Based on soil type and location, the AI suggests Zoysia Grass, which is durable and requires less water.'
                },
                'zone3': {
                    photo: 'https://placehold.co/200x200/c72c1c/fff5e0?text=Tomatoes',
                    description: 'This zone is optimized for vegetables. The AI predicts this area will grow tomatoes which require consistent moisture.'
                },
                'zone4': {
                    photo: 'https://placehold.co/200x200/942b00/d9b48f?text=Apple+Trees',
                    description: 'The AI has determined that this area is perfect for fruit trees due to its deeper soil and sunlight exposure.'
                }
            };

            for (const zone in aiCrops) {
                const crop = aiCrops[zone];
                const cropName = sensorData[zone].crop;
                const cropCard = document.createElement('div');
                cropCard.className = 'bg-gray-800 rounded-xl shadow-inner border border-gray-700 p-4';
                cropCard.innerHTML = `
                    <img src="${crop.photo}" alt="${cropName}" class="rounded-xl w-full h-auto mb-4">
                    <h3 class="text-xl font-bold text-gray-100 mb-2">${cropName}</h3>
                    <p class="text-gray-400 text-sm">${crop.description}</p>
                `;
                cropsContainer.appendChild(cropCard);
            }
        }


        async function simulateAiLogic() {
            const aiModeToggle = document.getElementById('aiModeToggle').checked;
            if (!aiModeToggle) return;
            
            const weather = currentWeatherData.condition;
            const recommendation = document.getElementById('aiRecommendationMessage');
            let overallMoisture = 0;
            let zonesNeedingAttention = [];

            for (const zone in sensorData) {
                overallMoisture += sensorData[zone].moisture;
                if (sensorData[zone].moisture < 30) {
                    zonesNeedingAttention.push(sensorData[zone].crop);
                }
            }
            const averageMoisture = overallMoisture / Object.keys(sensorData).length;

            let message = "";
            if (weather.includes("Rain Expected")) {
                message = `The AI predicts rain. All scheduled watering has been paused.`;
                if (isPumpOn) await savePumpStatus("off");
            } else if (zonesNeedingAttention.length > 0) {
                message = `Low moisture detected in ${zonesNeedingAttention.join(', ')}. AI is initiating a smart watering cycle.`;
                if (!isPumpOn) await savePumpStatus("on");
            } else if (averageMoisture > 75) {
                message = `All zones are sufficiently watered. AI has turned off the pump to prevent overwatering.`;
                if (isPumpOn) await savePumpStatus("off");
            } else {
                message = `Conditions are stable. The AI is monitoring soil moisture and weather for any changes.`;
            }
            recommendation.textContent = `**AI Prediction:** "${message}"`;
        }
        
        function updateDiagnostics() {
            const diagnosticsContainer = document.getElementById('diagnosticsContainer');
            diagnosticsContainer.innerHTML = ''; 
            
            const diagnostics = [];
            
            for (const zone in sensorData) {
                const data = sensorData[zone];
                if (data.moisture < 20) {
                    diagnostics.push({
                        type: 'Problem',
                        zone: data.crop,
                        message: `Extreme low soil moisture detected. Check the sensor and pump for Zone ${zone.replace('zone', '')}.`,
                        color: 'bg-red-500'
                    });
                } else if (data.moisture > 80) {
                    diagnostics.push({
                        type: 'Problem',
                        zone: data.crop,
                        message: `High moisture detected. Check for stuck pump or excessive rain for Zone ${zone.replace('zone', '')}.`,
                        color: 'bg-red-500'
                    });
                }
            }

            if (diagnostics.length === 0) {
                diagnostics.push({
                    type: 'Status',
                    zone: 'All Zones',
                    message: 'All system parameters are within optimal range. No issues detected.',
                    color: 'bg-green-500'
                });
            }

            diagnostics.forEach(diag => {
                const diagElement = document.createElement('div');
                diagElement.className = `${diag.color} text-white p-4 rounded-lg shadow-md mb-2`;
                diagElement.innerHTML = `<span class="font-bold">${diag.type} (${diag.zone}):</span> ${diag.message}`;
                diagnosticsContainer.appendChild(diagElement);
            });
        }
        
        function addMessage(text, isUser) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageElement = document.createElement('div');
            messageElement.className = `p-3 rounded-lg max-w-[80%] mb-3 ${isUser ? 'bg-blue-600 text-white ml-auto' : 'bg-gray-700 text-gray-200 mr-auto'}`;
            messageElement.textContent = text;
            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight; 
        }

     async function generateAiResponse(userInput) {
    const thinkingMessage = "Hydro-AI is thinking...";
    addMessage(thinkingMessage, false);

    const systemPrompt = `You are a helpful AI assistant for a smart irrigation system named Hydro-AI. 
    Your primary function is to provide information about the system's current status, sensor readings, and to process commands to update the system.
    You know about the different sections of the app:
    - **Dashboard**: Shows a high-level overview.
    - **Diagnostics**: Provides a health report and identifies problems.
    - **What's Growing?**: Gives information on the crops in each zone.
    
    You have access to three tools: 
    1. 'getZoneStatus' which provides real-time data for a specific irrigation zone.
    2. 'updateSensorData' which updates the data by generating new simulated values.
    3. 'setPumpStatus' which can turn the water pump on or off.
    4. 'getDiagnosticsSummary' which gives a summary of current system problems.
    5. 'getCropInformation' which provides details about a specific crop.

    - When the user asks about the status of a specific zone (e.g., 'vegetable patch' or 'zone 2'), you MUST use the 'getZoneStatus' tool with the correct zone ID.
    - When the user asks to update, change, or refresh the values, you MUST use the 'updateSensorData' tool.
    - When the user gives a command to turn the pump 'on' or 'off', you MUST use the 'setPumpStatus' tool.
    - When the user asks about system diagnostics or problems, you MUST use the 'getDiagnosticsSummary' tool.
    - When the user asks about a specific crop, you MUST use the 'getCropInformation' tool with the crop's name.

    Do not make up any information. If a question is outside the scope of the irrigation system status or control, acknowledge that you can't help with that.`;

    const payload = {
        systemInstruction: {
            parts: [{ text: systemPrompt }]
        },
        contents: [{ parts: [{ text: userInput }] }],
        tools: [
            {
                "functionDeclarations": [
                    {
                        "name": "getZoneStatus",
                        "description": "Get the current status of a specific irrigation zone. The available zones are 'zone1', 'zone2', 'zone3', and 'zone4'.",
                        "parameters": {
                            "type": "OBJECT",
                            "properties": {
                                "zoneId": {
                                    "type": "STRING",
                                    "description": "The ID of the irrigation zone (e.g., 'zone1', 'zone2')."
                                }
                            },
                            "required": ["zoneId"]
                        }
                    },
                    {
                        "name": "updateSensorData",
                        "description": "Updates the sensor data by generating new simulated values. Use this when the user asks to update or change the readings.",
                        "parameters": {
                            "type": "OBJECT",
                            "properties": {}
                        }
                    },
                    {
                        "name": "setPumpStatus",
                        "description": "Sets the status of the water pump to 'on' or 'off'.",
                        "parameters": {
                            "type": "OBJECT",
                            "properties": {
                                "status": {
                                    "type": "STRING",
                                    "description": "The desired status of the pump ('on' or 'off')."
                                }
                            },
                            "required": ["status"]
                        }
                    },
                    {
                        "name": "getDiagnosticsSummary",
                        "description": "Provides a summary of any problems detected by the system.",
                        "parameters": {
                            "type": "OBJECT",
                            "properties": {}
                        }
                    },
                    {
                        "name": "getCropInformation",
                        "description": "Provides information about a specific crop being grown. The available crops are 'Lavender', 'Zoysia Grass', 'Tomatoes', and 'Apple Trees'.",
                        "parameters": {
                            "type": "OBJECT",
                            "properties": {
                                "cropName": {
                                    "type": "STRING",
                                    "description": "The name of the crop (e.g., 'Lavender')."
                                }
                            },
                            "required": ["cropName"]
                        }
                    }
                ]
            }
        ]
    };

    try {
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
        const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (!response.ok) {
            throw new Error(`API call failed with status: ${response.status}`);
        }

        const result = await response.json();
        const candidate = result?.candidates?.[0];
        const functionCall = candidate?.content?.parts?.[0]?.functionCall;
        
        const messagesContainer = document.getElementById('chatMessages');
        messagesContainer.removeChild(messagesContainer.lastChild);
        
        if (functionCall) {
            if (functionCall.name === "getZoneStatus") {
                const zoneId = functionCall.args.zoneId;
                const status = {
                    moisture: sensorData[zoneId].moisture,
                    temperature: sensorData[zoneId].temperature,
                    humidity: sensorData[zoneId].humidity,
                };
                addMessage(`The current status for the ${sensorData[zoneId].crop} zone is:
- Soil Moisture: ${status.moisture}%
- Temperature: ${status.temperature}째C
- Humidity: ${status.humidity}%`, false);
            } else if (functionCall.name === "updateSensorData") {
                await triggerSimulatedSensorUpdate();
                addMessage("I have updated the sensor values. The dashboard is now showing the new readings.", false);
            } else if (functionCall.name === "setPumpStatus") {
                const pumpStatus = functionCall.args.status;
                await savePumpStatus(pumpStatus);
                addMessage(`The water pump has been turned ${pumpStatus}.`, false);
            } else if (functionCall.name === "getDiagnosticsSummary") {
                addMessage(getDiagnosticsSummary(), false);
            } else if (functionCall.name === "getCropInformation") {
                const cropName = functionCall.args.cropName;
                addMessage(getCropInformation(cropName), false);
            }
        } else {
            const aiResponse = candidate?.content?.parts?.[0]?.text;
            if (aiResponse) {
                addMessage(aiResponse, false);
            } else {
                addMessage("I'm sorry, I couldn't generate a response. Please try again.", false);
            }
        }
    } catch (error) {
        console.error("Error calling Gemini API:", error);
        addMessage("There was an error connecting to the AI. Please try again later.", false);
    }
}
        function handleChatInput() {
            const chatInput = document.getElementById('chatInput');
            const userInput = chatInput.value.trim();
            if (userInput) {
                addMessage(userInput, true);
                generateAiResponse(userInput);
                chatInput.value = '';
            }
        }
        
        function handleVoiceInput() {
            addMessage("Voice input is currently not active in this simulation, but it would work using the browser's SpeechRecognition API. What would you like to ask?", false);
        }

        let sensorInterval;
        function startSimulation() {
            if (!db) return;
            setInterval(updateWeatherData, 30000);
            updateWeatherData(); 

            sensorInterval = setInterval(async () => {
                for (const zone in sensorData) {
                    const moisture = Math.floor(Math.random() * 100);
                    const temperature = Math.floor(Math.random() * 20) + 15;
                    const humidity = Math.floor(Math.random() * 50) + 40;
                    const sensorDataPoint = {
                        moisture,
                        temperature,
                        humidity,
                        timestamp: serverTimestamp()
                    };
                    try {
                        await setDoc(doc(db, `/artifacts/${appId}/users/${userId}/data/sensors/${zone}`), sensorDataPoint);
                    } catch (e) {
                        console.error("Error adding document: ", e);
                    }
                }
            }, 5000); 
        }
        function getDiagnosticsSummary() {
    let problemZones = [];
    for (const zone in sensorData) {
        const data = sensorData[zone];
        if (data.moisture < 20 || data.moisture > 80) {
            problemZones.push(data.crop);
        }
    }

    if (problemZones.length > 0) {
        return `There are some issues detected. Low or high moisture levels were found in the following zones: ${problemZones.join(', ')}. Please check the Diagnostics tab for more details.`;
    } else {
        return "All systems are running normally. No issues have been detected.";
    }
}

function getCropInformation(cropName) {
    const crop = crops[cropName];
    if (crop) {
        return `Here is some information about ${cropName}: ${crop.description}`;
    } else {
        return `I'm sorry, I don't have information on a crop named ${cropName}. The available crops are Lavender, Zoysia Grass, Tomatoes, and Apple Trees.`;
    }
}
        function showMessage(msg, type = "info") {
            const messageBox = document.getElementById('statusMessage');
            messageBox.textContent = msg;
            messageBox.className = "p-4 rounded-md mt-4 text-sm font-medium transition-opacity duration-300";
            if (type === "success") {
                messageBox.classList.add('bg-green-500', 'text-white');
            } else if (type === "error") {
                messageBox.classList.add('bg-red-500', 'text-white');
            } else {
                messageBox.classList.add('bg-gray-800', 'text-gray-200');
            }
            messageBox.classList.remove('opacity-0');
            setTimeout(() => {
                messageBox.classList.add('opacity-0');
            }, 5000);
        }
        
        function updateActiveTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('border-green-500', 'text-green-500'));
            
            document.getElementById(`${tabName}-tab`).classList.remove('hidden');
            document.getElementById(`tab-btn-${tabName}`).classList.add('border-green-500', 'text-green-500');
        }

        function setActiveZone(zoneId) {
            activeZone = zoneId;
            const data = sensorData[zoneId];
            document.getElementById('zoneDetailTitle').textContent = `${data.crop} - Zone ${zoneId.replace('zone', '')}`;
            document.getElementById('moistureValue').textContent = `${data.moisture}%`;
            document.getElementById('moistureBar').style.width = `${data.moisture}%`;
            document.getElementById('moistureBar').className = `h-full rounded-full ${data.moisture > 60 ? 'bg-green-500' : data.moisture > 30 ? 'bg-yellow-500' : 'bg-red-500'}`;
            document.getElementById('tempValue').textContent = `${data.temperature}째C`;
            document.getElementById('humidityValue').textContent = `${data.humidity}%`;
        }

        // --- Authentication Functions ---
        function updateAuthView(viewName) {
            document.querySelectorAll('.auth-view').forEach(el => el.classList.add('hidden'));
            document.getElementById(viewName).classList.remove('hidden');
        }

        async function handleEmailSignUp(e) {
            e.preventDefault();
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            try {
                await createUserWithEmailAndPassword(auth, email, password);
                showMessage("Account created successfully. Logging you in...", "success");
            } catch (error) {
                console.error("Signup error:", error);
                showMessage(`Signup failed: ${error.message}`, "error");
            }
        }

        async function handleEmailLogin(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
                showMessage("Logged in successfully!", "success");
            } catch (error) {
                console.error("Login error:", error);
                showMessage(`Login failed: ${error.message}`, "error");
            }
        }

        async function handleGoogleLogin() {
            try {
                const provider = new GoogleAuthProvider();
                await signInWithPopup(auth, provider);
                showMessage("Logged in with Google successfully!", "success");
            } catch (error) {
                console.error("Google login error:", error);
                showMessage(`Google login failed: ${error.message}`, "error");
            }
        }
        
        async function handlePasswordReset() {
            const email = document.getElementById('loginEmail').value;
            if (email) {
                try {
                    await sendPasswordResetEmail(auth, email);
                    showMessage("Password reset email sent. Check your inbox.", "success");
                } catch (error) {
                    console.error("Password reset error:", error);
                    showMessage(`Password reset failed: ${error.message}`, "error");
                }
            } else {
                showMessage("Please enter your email in the login form to reset your password.", "error");
            }
        }

        async function handleSignOut() {
            try {
                await signOut(auth);
                showMessage("Signed out successfully.", "success");
            } catch (error) {
                console.error("Sign out error:", error);
                showMessage(`Sign out failed: ${error.message}`, "error");
            }
        }

        window.onload = function() {
            initFirebase();
            updateActiveTab('dashboard');
            
            // Set up dark mode based on local storage or system preference
            if (localStorage.theme === 'light' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: light)').matches)) {
                document.body.setAttribute('data-theme', 'light');
            } else {
                document.body.setAttribute('data-theme', 'dark');
            }

            document.getElementById('mode-toggle').addEventListener('click', () => {
                const isLightMode = document.body.getAttribute('data-theme') === 'light';
                const newTheme = isLightMode ? 'dark' : 'light';
                document.body.setAttribute('data-theme', newTheme);
                localStorage.theme = newTheme;
            });

            document.getElementById('pumpControlButton').addEventListener('click', async () => {
                const pumpStatus = isPumpOn ? "off" : "on";
                await savePumpStatus(pumpStatus);
            });

            document.getElementById('aiModeToggle').addEventListener('change', async (event) => {
                const isAiMode = event.target.checked;
                await saveAiMode(isAiMode);
            });

            document.getElementById('tab-btn-dashboard').addEventListener('click', () => updateActiveTab('dashboard'));
            document.getElementById('tab-btn-assistant').addEventListener('click', () => updateActiveTab('assistant'));
            document.getElementById('tab-btn-diagnostics').addEventListener('click', () => updateActiveTab('diagnostics'));
            document.getElementById('tab-btn-crops').addEventListener('click', () => {
                updateActiveTab('crops');
                updateCropsAndCropsInfo();
            });
            
            document.getElementById('sendButton').addEventListener('click', handleChatInput);
            document.getElementById('voiceButton').addEventListener('click', handleVoiceInput);
            document.getElementById('chatInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleChatInput();
                }
            });

            document.querySelectorAll('.zone-card').forEach(card => {
                card.addEventListener('click', (event) => {
                    const zoneId = event.currentTarget.dataset.zone;
                    setActiveZone(zoneId);
                    document.getElementById('dashboardView').classList.add('hidden');
                    document.getElementById('zoneDetailView').classList.remove('hidden');
                });
            });

            document.getElementById('showDashboard').addEventListener('click', () => {
                document.getElementById('dashboardView').classList.remove('hidden');
                document.getElementById('zoneDetailView').classList.add('hidden');
            });
            
            // Auth listeners
            document.getElementById('login-form').addEventListener('submit', handleEmailLogin);
            document.getElementById('signup-form').addEventListener('submit', handleEmailSignUp);
            document.getElementById('google-login-btn').addEventListener('click', handleGoogleLogin);
            document.getElementById('forgot-password-link').addEventListener('click', handlePasswordReset);
            document.getElementById('logout-btn').addEventListener('click', handleSignOut);
            
            document.getElementById('showSignup').addEventListener('click', (e) => {
                e.preventDefault();
                updateAuthView('signup');
            });
            document.getElementById('showLogin').addEventListener('click', (e) => {
                e.preventDefault();
                updateAuthView('login');
            });
        };
    </script>
    <style>
        body[data-theme='dark'] {
            --bg-color: #0d111c;
            --text-color: #e2e8f0;
            --card-bg: #161b22;
            --border-color: #24292f;
            --input-bg: #1a1f26;
            --input-border: #30363d;
            --button-bg-primary: #1e7145;
            --button-hover-primary: #15623e;
            --text-secondary: #94a3b8;
        }

        body[data-theme='light'] {
            --bg-color: #ffffff;
            --text-color: #1f2937;
            --card-bg: #f3f4f6;
            --border-color: #d1d5db;
            --input-bg: #e5e7eb;
            --input-border: #9ca3af;
            --button-bg-primary: #10b981;
            --button-hover-primary: #059669;
            --text-secondary: #6b7280;
        }
        
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }
        
        .bg-gray-950, .bg-gray-900, .bg-gray-800, .bg-gray-700 {
            background-color: var(--card-bg);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }
        .text-gray-200, .text-gray-100 {
            color: var(--text-color);
            transition: color 0.3s;
        }
        .text-gray-400, .text-gray-500 {
            color: var(--text-secondary);
            transition: color 0.3s;
        }
        .border-gray-800, .border-gray-700 {
            border-color: var(--border-color);
            transition: border-color 0.3s;
        }
        
        input, .bg-gray-900, .bg-gray-800, .bg-gray-700 {
            background-color: var(--input-bg);
            color: var(--text-color);
            border-color: var(--input-border);
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }

        .bg-green-600 {
            background-color: var(--button-bg-primary);
            transition: background-color 0.3s;
        }
        .hover\:bg-green-700:hover {
            background-color: var(--button-hover-primary);
        }
        .text-green-400 {
            color: var(--button-bg-primary);
        }
        .hover\:text-green-400:hover {
            color: var(--button-hover-primary);
        }

        .mode-toggle-btn {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
            cursor: pointer;
            border-radius: 9999px;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }
        
        .mode-toggle-btn::before {
            content: '';
            position: absolute;
            left: 2px;
            top: 2px;
            width: 22px;
            height: 22px;
            border-radius: 9999px;
            background-color: var(--text-color);
            transition: transform 0.3s ease;
        }
        
        body[data-theme='light'] .mode-toggle-btn::before {
            transform: translateX(22px);
        }

        .mode-toggle-btn .icon {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 18px;
            height: 18px;
            transition: opacity 0.3s ease;
        }
        
        .mode-toggle-btn .moon-icon {
            left: 5px;
            opacity: 1;
        }
        
        body[data-theme='light'] .mode-toggle-btn .moon-icon {
            opacity: 0;
        }
        
        .mode-toggle-btn .sun-icon {
            right: 5px;
            opacity: 0;
        }
        
        body[data-theme='light'] .mode-toggle-btn .sun-icon {
            opacity: 1;
        }
        
        #moistureBar {
            transition: width 0.5s ease-in-out;
        }
        .tab-button {
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease-in-out;
        }
    </style>
</head>
<body data-theme="dark" class="min-h-screen p-4 sm:p-8 flex items-center justify-center">
    
    <!-- Authentication Container (shown by default) -->
    <div id="authContainer" class="w-full max-w-sm bg-gray-900 rounded-2xl p-6 sm:p-10 shadow-lg border border-gray-800">
        <div id="login" class="auth-view">
            <h2 class="text-3xl font-bold text-center text-gray-100 mb-6">Log In</h2>
            <form id="login-form">
                <div class="mb-4">
                    <input type="email" id="loginEmail" placeholder="Email" class="w-full p-3 rounded-lg bg-gray-800 text-gray-200 border border-gray-700 focus:outline-none focus:ring-2 focus:ring-green-500" required>
                </div>
                <div class="mb-6">
                    <input type="password" id="loginPassword" placeholder="Password" class="w-full p-3 rounded-lg bg-gray-800 text-gray-200 border border-gray-700 focus:outline-none focus:ring-2 focus:ring-green-500" required>
                </div>
                <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg transition-colors">Log In</button>
            </form>
            <div class="text-center mt-4 text-gray-400 text-sm">
                <a href="#" id="forgot-password-link" class="hover:text-green-400">Forgot Password?</a>
            </div>
            <div class="text-center my-4 text-gray-500">
                OR
            </div>
            <div class="flex flex-col space-y-3">
                <button id="google-login-btn" class="w-full flex items-center justify-center gap-2 bg-gray-800 hover:bg-gray-700 text-white font-bold py-3 rounded-lg transition-colors border border-gray-700">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M22.56 12.28c0-.78-.07-1.54-.2-2.28H12v4.51h6.24c-.28 1.48-1.15 2.76-2.52 3.63v3.29h4.21a11.16 11.16 0 003.57-8.15z" />
                        <path d="M12 23.99c2.83 0 5.19-.93 6.92-2.52l-4.2-3.29c-1.15.77-2.6.99-4.32.99-3.32 0-6.14-2.23-7.14-5.22H.67v3.29a12 12 0 0011.33 8.75z" />
                        <path d="M4.86 14.12c-.5-.14-1.01-.2-1.52-.2-.51 0-1.02.06-1.52.2V10.83H.67a12.02 12.02 0 000 6.34h1.15a8.77 8.77 0 013.04-4.22z" />
                        <path d="M12 4.86c1.69 0 3.2.58 4.39 1.77l3.77-3.77A11.96 11.96 0 0012 .13C5.64.13.38 5.4.38 12h1.15c0-4.6 3.06-8.52 7.29-9.87z" />
                    </svg>
                    <span>Sign in with Google</span>
                </button>
            </div>
            <div class="text-center mt-6 text-gray-400">
                Don't have an account? <a href="#" id="showSignup" class="text-green-400 font-semibold hover:underline">Sign up</a>
            </div>
        </div>
        <div id="signup" class="auth-view hidden">
            <h2 class="text-3xl font-bold text-center text-gray-100 mb-6">Sign Up</h2>
            <form id="signup-form">
                <div class="mb-4">
                    <input type="email" id="signupEmail" placeholder="Email" class="w-full p-3 rounded-lg bg-gray-800 text-gray-200 border border-gray-700 focus:outline-none focus:ring-2 focus:ring-green-500" required>
                </div>
                <div class="mb-6">
                    <input type="password" id="signupPassword" placeholder="Password" class="w-full p-3 rounded-lg bg-gray-800 text-gray-200 border border-gray-700 focus:outline-none focus:ring-2 focus:ring-green-500" required>
                </div>
                <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg transition-colors">Sign Up</button>
            </form>
            <div class="text-center mt-6 text-gray-400">
                Already have an account? <a href="#" id="showLogin" class="text-green-400 font-semibold hover:underline">Log In</a>
            </div>
        </div>
    </div>

    <!-- Main App Container (hidden by default) -->
    <div id="appContainer" class="hidden w-full max-w-4xl bg-gray-900 rounded-2xl p-6 sm:p-10 shadow-lg border border-gray-800">
        <!-- Header -->
        <header class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-8">
            <div class="flex items-center gap-4 mb-4 sm:mb-0">
                <div class="p-2 bg-green-500 rounded-full">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v18M12 3c-1.105 0-2 .895-2 2s.895 2 2 2h0c1.105 0 2-.895 2-2s-.895-2-2-2zM4 14h16m-8 0a4 4 0 100-8 4 4 0 000 8z"></path>
                    </svg>
                </div>
                <h1 class="text-3xl sm:text-4xl font-bold text-gray-100">Hydro-AI</h1>
            </div>
            <div class="flex items-center gap-4">
                <label id="mode-toggle" class="mode-toggle-btn">
                    <svg class="moon-icon icon" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M21.73 17.51a1.2 1.2 0 01-1.35.34A9.91 9.91 0 0013.06 4.3a1.2 1.2 0 01-1.1-2.12c-.22-.38-.72-.51-1.12-.32A10.87 10.87 0 002.5 12c0 5.92 4.8 10.74 10.71 10.74a10.87 10.87 0 008.85-4.54 1.2 1.2 0 01.37-1.07zm-2.88-2.67a8.55 8.55 0 01-6.15 2.53A8.53 8.53 0 015.65 12a8.55 8.55 0 016.15-2.52 8.53 8.53 0 017.05 4.7z"></path>
                    </svg>
                    <svg class="sun-icon icon" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 4.5a.9.9 0 00-1 0 .9.9 0 00-.5 1.5l1.62 1.62a.9.9 0 001.28 0l1.62-1.62a.9.9 0 00-.5-1.5zM3 12a.9.9 0 001.8 0 .9.9 0 00-1.8 0zM21 12a.9.9 0 001.8 0 .9.9 0 00-1.8 0zM12 21a.9.9 0 001-1.5l-1.62-1.62a.9.9 0 00-1.28 0L9.5 19.5a.9.9 0 00.5 1.5zM5.5 5.5a.9.9 0 00-1.27 0 .9.9 0 000 1.28l1.62 1.62a.9.9 0 001.28 0l1.62-1.62a.9.9 0 00-1.28 0zM18.5 18.5a.9.9 0 00-1.27 0 .9.9 0 000 1.28l1.62 1.62a.9.9 0 001.28 0l1.62-1.62a.9.9 0 00-1.28 0zM18.5 5.5a.9.9 0 00-1.27 0 .9.9 0 000 1.28l1.62 1.62a.9.9 0 001.28 0l1.62-1.62a.9.9 0 00-1.28 0zM5.5 18.5a.9.9 0 00-1.27 0 .9.9 0 000 1.28l1.62 1.62a.9.9 0 001.28 0l1.62-1.62a.9.9 0 00-1.28 0zM12 10.5a1.5 1.5 0 100 3 1.5 1.5 0 000-3z"></path>
                    </svg>
                </label>
                <div class="flex flex-col items-start sm:items-end text-sm text-gray-400">
                    <span id="userIdDisplay" class="truncate">User: Loading...</span>
                    <button id="logout-btn" class="mt-1 text-red-400 hover:text-red-500 font-semibold">Log Out</button>
                </div>
            </div>
        </header>

        <!-- Status Message -->
        <div id="statusMessage" class="opacity-0 transition-opacity duration-300"></div>

        <!-- Tab Navigation -->
        <div class="flex border-b border-gray-700 mb-6">
            <button id="tab-btn-dashboard" class="tab-button flex-1 text-center py-3 text-lg font-semibold text-gray-400 hover:text-gray-200 hover:border-gray-500">Dashboard</button>
            <button id="tab-btn-assistant" class="tab-button flex-1 text-center py-3 text-lg font-semibold text-gray-400 hover:text-gray-200 hover:border-gray-500">AI Assistant</button>
            <button id="tab-btn-diagnostics" class="tab-button flex-1 text-center py-3 text-lg font-semibold text-gray-400 hover:text-gray-200 hover:border-gray-500">Diagnostics</button>
            <button id="tab-btn-crops" class="tab-button flex-1 text-center py-3 text-lg font-semibold text-gray-400 hover:text-gray-200 hover:border-gray-500">What's Growing?</button>
        </div>

        <!-- Dashboard Content -->
        <div id="dashboard-tab" class="tab-content view">
            <div id="dashboardView" class="view">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                    <div class="bg-gray-800 p-6 rounded-xl shadow-inner border border-gray-700">
                        <h3 class="text-sm text-gray-400 mb-2">System Status</h3>
                        <div class="flex items-center justify-between">
                            <span id="systemStatus" class="text-xl font-bold text-green-400">All Zones OK</span>
                            <div id="pumpIndicator" class="w-4 h-4 rounded-full bg-red-500 animate-pulse"></div>
                        </div>
                    </div>
                    <div class="bg-gray-800 p-6 rounded-xl shadow-inner border border-gray-700">
                        <h3 class="text-sm text-gray-400 mb-2">Current Weather</h3>
                        <div class="flex items-center gap-2">
                            <svg class="w-8 h-8 text-yellow-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364-6.364l-.707-.707M6.343 17.657l-.707.707M16.364 6.364l.707-.707M6.343 6.343l.707-.707M12 8a4 4 0 100 8 4 4 0 000-8z"></path>
                            </svg>
                            <div>
                                <span id="currentWeatherCondition" class="text-xl font-bold text-gray-100">Loading...</span>
                                <span class="text-sm text-gray-400"><span id="currentTemperature"></span>, <span id="currentHumidity"></span></span>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gray-800 p-6 rounded-xl shadow-inner border border-gray-700">
                        <h3 class="text-sm text-gray-400 mb-2">Next Watering</h3>
                        <p class="text-lg font-bold text-gray-100">Tomorrow at 6:00 AM</p>
                        <p class="text-xs text-gray-500">Scheduled by AI</p>
                    </div>
                </div>

                <div class="bg-gray-800 p-6 rounded-xl shadow-inner border border-gray-700 mb-8">
                    <h3 class="text-lg font-semibold text-gray-100 mb-4">Garden Zone</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="zone-card relative bg-gray-700 rounded-lg p-6 text-center cursor-pointer hover:bg-gray-600 transition-colors" data-zone="zone1" id="zone1-moisture-card">
                            <span class="status-indicator absolute top-2 right-2 w-3 h-3 rounded-full bg-green-500 animate-pulse"></span>
                            <img id="zone1-live-image" class="w-full h-auto rounded-lg mb-2" src="https://placehold.co/200x150/52382f/ffffff?text=Flower+Bed" alt="Live soil image">
                            <h4 class="text-base font-semibold text-gray-100">Flower Bed</h4>
                            <p class="text-sm text-gray-400">Moisture: <span class="moisture-value">75%</span></p>
                        </div>
                        <div class="zone-card relative bg-gray-700 rounded-lg p-6 text-center cursor-pointer hover:bg-gray-600 transition-colors" data-zone="zone2" id="zone2-moisture-card">
                            <span class="status-indicator absolute top-2 right-2 w-3 h-3 rounded-full bg-yellow-500"></span>
                            <img id="zone2-live-image" class="w-full h-auto rounded-lg mb-2" src="https://placehold.co/200x150/474c3e/ffffff?text=Lawn" alt="Live soil image">
                            <h4 class="text-base font-semibold text-gray-100">Lawn</h4>
                            <p class="text-sm text-gray-400">Moisture: <span class="moisture-value">40%</span></p>
                        </div>
                        <div class="zone-card relative bg-gray-700 rounded-lg p-6 text-center cursor-pointer hover:bg-gray-600 transition-colors" data-zone="zone3" id="zone3-moisture-card">
                            <span class="status-indicator absolute top-2 right-2 w-3 h-3 rounded-full bg-red-500"></span>
                            <img id="zone3-live-image" class="w-full h-auto rounded-lg mb-2" src="https://placehold.co/200x150/453b3d/ffffff?text=Vegetable+Patch" alt="Live soil image">
                            <h4 class="text-base font-semibold text-gray-100">Vegetable Patch</h4>
                            <p class="text-sm text-gray-400">Moisture: <span class="moisture-value">22%</span></p>
                        </div>
                        <div class="zone-card relative bg-gray-700 rounded-lg p-6 text-center cursor-pointer hover:bg-gray-600 transition-colors" data-zone="zone4" id="zone4-moisture-card">
                            <span class="status-indicator absolute top-2 right-2 w-3 h-3 rounded-full bg-green-500"></span>
                            <img id="zone4-live-image" class="w-full h-auto rounded-lg mb-2" src="https://placehold.co/200x150/615a45/ffffff?text=Fruit+Trees" alt="Live soil image">
                            <h4 class="text-base font-semibold text-gray-100">Fruit Trees</h4>
                            <p class="text-sm text-gray-400">Moisture: <span class="moisture-value">68%</span></p>
                        </div>
                    </div>
                </div>

                <div class="bg-gray-800 p-6 rounded-xl shadow-inner border border-gray-700">
                    <h3 class="text-lg font-semibold text-gray-100 mb-4">AI & System Control</h3>
                    
                    <div class="flex items-center justify-between mb-4">
                        <span class="text-gray-400">Enable AI-Powered Mode</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="aiModeToggle" class="sr-only peer" checked>
                            <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-green-400 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                        </label>
                    </div>
                    
                    <div id="aiRecommendations">
                        <p class="text-gray-400 mb-4">The AI is actively monitoring conditions and optimizing your schedule.</p>
                        <div class="p-4 bg-gray-700 rounded-lg">
                            <p id="aiRecommendationMessage" class="text-sm text-gray-200">
                                **AI Prediction:** "Loading initial data..."
                            </p>
                        </div>
                    </div>

                    <div id="manualControls" class="hidden">
                        <p class="text-gray-400 mb-4">You have disabled AI mode. Manual controls are now active.</p>
                        <button id="pumpControlButton" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-xl transition-colors">
                            START PUMP
                        </button>
                        <p class="text-center text-gray-500 text-xs mt-2">Current pump status: <span id="pumpStatusText">OFF</span></p>
                    </div>
                </div>
            </div>

            <!-- Zone Detail View (Hidden by default) -->
            <div id="zoneDetailView" class="view hidden">
                <button id="showDashboard" class="text-gray-400 hover:text-gray-200 mb-6 flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                    Back to Dashboard
                </button>
                <h2 id="zoneDetailTitle" class="text-3xl font-bold text-gray-100 mb-6">Flower Bed - Zone 1</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                    <!-- Sensor Reading Card -->
                    <div class="bg-gray-800 p-6 rounded-xl shadow-inner border border-gray-700">
                        <h3 class="text-sm text-gray-400 mb-2">Soil Moisture</h3>
                        <div class="flex items-end gap-2 mb-2">
                            <span id="moistureValue" class="text-4xl font-extrabold text-green-400">75%</span>
                        </div>
                        <div class="w-full bg-gray-700 h-2 rounded-full overflow-hidden">
                            <div id="moistureBar" class="h-full rounded-full" style="width: 75%;"></div>
                        </div>
                    </div>
                    
                    <!-- Temperature Card -->
                    <div class="bg-gray-800 p-6 rounded-xl shadow-inner border border-gray-700">
                        <h3 class="text-sm text-gray-400 mb-2">Temperature</h3>
                        <span id="tempValue" class="text-4xl font-extrabold text-gray-100">25째C</span>
                        <p class="text-sm text-gray-500 mt-1">Optimal for this crop</p>
                    </div>
                    
                    <!-- Humidity Card -->
                    <div class="bg-gray-800 p-6 rounded-xl shadow-inner border border-gray-700">
                        <h3 class="text-sm text-gray-400 mb-2">Humidity</h3>
                        <span id="humidityValue" class="text-4xl font-extrabold text-gray-100">65%</span>
                        <p class="text-sm text-gray-500 mt-1">Air humidity</p>
                    </div>
                </div>
                
                <!-- Historical Data (Graph Placeholder) -->
                <div class="bg-gray-800 p-6 rounded-xl shadow-inner border border-gray-700">
                    <h3 class="text-lg font-semibold text-gray-100 mb-4">Moisture Trends (Past 7 Days)</h3>
                    <div class="w-full h-48 bg-gray-700 rounded-lg flex items-center justify-center text-gray-500 italic">
                        [ Placeholder for Chart.js graph ]
                    </div>
                </div>
            </div>
        </div>
        
        <!-- AI Assistant Tab -->
        <div id="assistant-tab" class="tab-content hidden">
            <div class="flex flex-col h-[60vh] max-h-[60vh] bg-gray-800 rounded-xl shadow-inner border border-gray-700">
                <div id="chatMessages" class="flex-1 p-6 overflow-y-auto flex flex-col space-y-3">
                    <!-- Chat messages will be appended here -->
                    <div class="p-3 rounded-lg max-w-[80%] bg-gray-700 text-gray-200 mr-auto">
                        Hello! I am Hydro-AI, your smart irrigation assistant. How can I help?
                    </div>
                </div>
                <div class="p-4 border-t border-gray-700 flex items-center gap-2">
                    <input id="chatInput" type="text" placeholder="Ask about soil moisture, weather, or pump status..." class="flex-1 bg-gray-900 text-white rounded-full px-4 py-2 focus:outline-none focus:ring-2 focus:ring-green-500">
                    <button id="voiceButton" class="bg-gray-700 hover:bg-gray-600 rounded-full p-2 transition-colors">
                        <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a4 4 0 11-8 0 4 4 0 018 0z"></path>
                        </svg>
                    </button>
                    <button id="sendButton" class="bg-green-600 hover:bg-green-700 text-white rounded-full p-2 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M12 5l7 7-7 7"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Diagnostics Tab -->
        <div id="diagnostics-tab" class="tab-content hidden">
            <h3 class="text-2xl font-bold text-gray-100 mb-4">System Health & Diagnostics</h3>
            <p class="text-sm text-gray-400 mb-6">Hydro-AI continuously monitors all components and provides real-time health checks and suggestions.</p>
            <div id="diagnosticsContainer" class="flex flex-col space-y-4">
                <!-- Diagnostics messages will be dynamically added here -->
            </div>
        </div>

        <!-- Crops Tab -->
        <div id="crops-tab" class="tab-content hidden">
            <h3 class="text-2xl font-bold text-gray-100 mb-4">What's Growing?</h3>
            <p class="text-sm text-gray-400 mb-6">Here are the crops in your garden and their specific care needs.</p>
            <div id="cropsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <!-- Crop cards will be dynamically added here -->
            </div>
        </div>
        
    </div>
</body>
</html>
