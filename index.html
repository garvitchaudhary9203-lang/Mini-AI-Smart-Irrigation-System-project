<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hydro-AI:SIS - Simulation with Graph</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M12 3v18M12 3c-1.105 0-2 .895-2 2s.895 2 2 2h0c1.105 0 2-.895 2-2s-.895-2-2-2zM4 14h16m-8 0a4 4 0 100-8 4 4 0 000 8z'/%3E%3C/svg%3E" type="image/svg+xml">
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.2.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script type="module">
        // MOCK/SIMULATION OVERRIDES
        // Since the original code relies on Firebase imports which won't function without configuration/network,
        // we override the Firebase-related calls to use local variables and mocks for the simulation.
        
        // Mock imports to prevent errors
        const initializeApp = () => ({}); 
        const getAuth = () => ({});
        const onAuthStateChanged = (auth, callback) => callback({ uid: 'simulated-user-id' });
        const getFirestore = () => ({});
        const doc = () => ({});
        const getDoc = async () => ({ exists: () => true, data: () => ({ pumpStatus: "off", aiMode: true }) });
        const setDoc = async () => console.log("MOCK: Data saved to Firestore.");
        const onSnapshot = (q, callback) => { /* Mock for Firestore is handled in simulation */ };
        const collection = () => ({});
        const query = () => ({});
        const serverTimestamp = () => new Date().toISOString(); 
        const getDatabase = () => ({});
        const ref = () => ({});
        const onValue = (ref, callback) => { /* Mock for RTDB is handled in simulation */ };

        const appId = 'default-app-id';
        const firebaseConfig = {}; // Ignored for simulation
        const initialAuthToken = null;
        
        let db;
        let rtdb; 
        let auth;
        let userId;
        
        // Initialize sensorData with realistic starting values for the simulation
        let sensorData = {
            'zone1': { moisture: 75, temperature: 25, humidity: 60, crop: 'Lavender' },
            'zone2': { moisture: 40, temperature: 28, humidity: 55, crop: 'Zoysia Grass' },
            'zone3': { moisture: 22, temperature: 30, humidity: 50, crop: 'Tomatoes' },
            'zone4': { moisture: 68, temperature: 23, humidity: 65, crop: 'Apple Trees' }
        };
        let currentWeatherData = { temperature: 25, humidity: 65, condition: "Partly Cloudy" };
        let isPumpOn = false;
        let activeZone = 'zone1';

        // --- NEW/MODIFIED STATE FOR SIMULATION & GRAPHING ---
        let moistureHistory = {
            'zone1': Array(14).fill(75),
            'zone2': Array(14).fill(40),
            'zone3': Array(14).fill(22),
            'zone4': Array(14).fill(68)
        };
        let moistureChart = null;
        let rtdbMoistureRaw = 2000;
        let rtdbTemp = 25;
        let rtdbHumidity = 50;

        // --- TensorFlow.js Model Integration Variables ---
        let tfjsModel = true; // Mock as loaded for simulation
        const SCALER_MEAN = [45.4859625, 22.5528125, 44.98325]; 
        const SCALER_STD = [26.002991230790848, 13.259638412861953, 14.716702057102202]; 
        
        // ... (crops object remains the same)

        const crops = {
            'Lavender': {
                photo: 'https://placehold.co/200x200/4c3b53/f3e8ff?text=Lavender',
                description: 'A drought-tolerant perennial that thrives in full sun and well-drained soil. Requires minimal watering once established.'
            },
            'Zoysia Grass': {
                photo: 'https://placehold.co/200x200/526d3d/d2ffc0?text=Zoysia+Grass',
                description: 'A warm-season grass known for its durability and drought resistance. It requires less water than other common lawn types.'
            },
            'Tomatoes': {
                photo: 'https://placehold.co/200x200/c72c1c/fff5e0?text=Tomatoes',
                description: 'A heat-loving vegetable that requires consistent moisture to prevent cracking and blossom-end rot. Needs more frequent watering.'
            },
            'Apple Trees': {
                photo: 'https://placehold.co/200x200/942b00/d9b48f?text=Apple+Trees',
                description: 'Established trees have deep roots and require less frequent but deep watering. Proper irrigation is crucial for fruit development.'
            }
        };

        // --- NEW FUNCTION: AI Model Prediction (Mocked Logic) ---
        async function aiPredict(moisture, temperature, humidity) {
            if (!tfjsModel) return 0;
            if (moisture < 35 && temperature > 25) return 1; // Needs water
            if (moisture > 75) return 0; // Oversaturated
            return Math.random() > 0.5 ? 1 : 0; // Random prediction otherwise
        }

        // --- NEW FUNCTION: Model Loading (Mocked) ---
        async function loadModel() {
            console.log("MOCK: TensorFlow.js Model is considered loaded for simulation.");
            showMessage("AI Model Loaded (Simulation Mode).", "success");
            // tfjsModel = await tf.loadLayersModel('./tfjs_model_web/model.json'); // Actual line kept commented
        }

        // --- NEW FUNCTION: RTDB Display Update (Simulated) ---
        function updateRtdbDisplay(moistureRaw, tempRaw, humidityRaw, pumpStatus) {
            const percentage = moistureRaw !== null ? Math.round((1 - (moistureRaw / 4095)) * 100) : '--'; 
            document.getElementById("soil").textContent = percentage > 100 ? "100%" : `${percentage}%`;
            document.getElementById("temperature").textContent = tempRaw !== null ? `${tempRaw}°C` : '--';
            document.getElementById("humidity").textContent = humidityRaw !== null ? `${humidityRaw}%` : '--';
            document.getElementById("status").textContent = pumpStatus || 'N/A';
        }

        // --- MODIFIED FUNCTION: initFirebase (Mocked Login/Setup) ---
        async function initFirebase() {
            try {
                // Mock Firebase Initialization
                const user = { uid: 'simulated-user-id' };
                userId = user.uid;
                const formattedUid = `${userId.substring(0, 4)}-${Math.floor(Math.random() * 9000) + 1000}-!@#*`;
                document.getElementById('userIdDisplay').textContent = `User: ${formattedUid}`;
                document.getElementById('authContainer').classList.add('hidden');
                document.getElementById('appContainer').classList.remove('hidden');

                await loadModel(); 
                // setupRealtimeListeners(); // Mocked out
                // setupRtdbListener();     // Mocked out
                startSimulation(); 
                updateAiMode(true); // Start in AI mode
            } catch (error) {
                console.error("Error initializing Simulation:", error);
                document.getElementById('statusMessage').textContent = "Error: Could not start simulation.";
            }
        }
        
        // --- MODIFIED FUNCTION: setupRtdbListener (Mocked out) ---
        async function setupRtdbListener() {
            console.log("MOCK: Realtime Database Listener bypassed.");
        }

        // --- MODIFIED FUNCTION: setupRealtimeListeners (Mocked out) ---
        async function setupRealtimeListeners() {
            console.log("MOCK: Firestore Realtime Listener bypassed.");
        }

        // --- MODIFIED FUNCTION: savePumpStatus (Use local state) ---
        async function savePumpStatus(status){
            isPumpOn = (status === "on");
            updatePumpStatus(isPumpOn);
            // setDoc() is a mock function, so we call it but it does nothing
            // await setDoc(doc(db, `/artifacts/${appId}/users/${userId}/data/settings`), { pumpStatus: status, lastManualOverride: serverTimestamp() }, { merge: true });
        }

        // --- MODIFIED FUNCTION: saveAiMode (Use local state) ---
        async function saveAiMode(mode) {
            updateAiMode(mode);
            // setDoc() is a mock function, so we call it but it does nothing
            // await setDoc(settingsDocRef, { aiMode: mode }, { merge: true });
            showMessage(`AI Mode ${mode ? 'Enabled' : 'Disabled'} (SIMULATION).`, "success");
        }

        // --- MODIFIED FUNCTION: updateSensorReadings (Also updates history) ---
        function updateSensorReadings(zoneId, data) {
            sensorData[zoneId] = data;

            // Update history data (Last 14 samples)
            const moisture = data.moisture !== undefined ? Math.round(data.moisture) : 0;
            moistureHistory[zoneId].push(moisture);
            if (moistureHistory[zoneId].length > 14) {
                moistureHistory[zoneId].shift(); // Remove the oldest point
            }

            const moistureCard = document.getElementById(`${zoneId}-moisture-card`);
            if (moistureCard) {
                const moistureValue = moistureCard.querySelector('.moisture-value');
                const moistureBar = moistureCard.querySelector('.moisture-bar');
                
                moistureValue.textContent = `${moisture}%`;
                moistureBar.style.width = `${moisture}%`;
                
                moistureBar.classList.remove('bg-green-500', 'bg-yellow-500', 'bg-red-500');
                if (moisture > 60) moistureBar.classList.add('bg-green-500');
                else if (moisture > 30) moistureBar.classList.add('bg-yellow-500');
                else moistureBar.classList.add('bg-red-500');

                const statusIndicator = moistureCard.querySelector('.status-indicator');
                statusIndicator.classList.remove('bg-green-500', 'bg-yellow-500', 'bg-red-500', 'animate-pulse');
                if (moisture > 60) statusIndicator.classList.add('bg-green-500', 'animate-pulse');
                else if (moisture > 30) statusIndicator.classList.add('bg-yellow-500');
                else statusIndicator.classList.add('bg-red-500');
            }

            if (zoneId === activeZone) {
                document.getElementById('moistureValue').textContent = `${moisture}%`;
                document.getElementById('moistureBar').style.width = `${moisture}%`;
                document.getElementById('moistureBar').className = `h-full rounded-full ${moisture > 60 ? 'bg-green-500' : moisture > 30 ? 'bg-yellow-500' : 'bg-red-500'}`;
                document.getElementById('tempValue').textContent = `${data.temperature !== undefined ? Math.round(data.temperature) : '--'}°C`;
                document.getElementById('humidityValue').textContent = `${data.humidity !== undefined ? Math.round(data.humidity) : '--'}%`;
                
                // Update the chart for the active zone
                updateMoistureChart(activeZone);
            }
        }

        // --- NEW FUNCTION: Create/Update Chart ---
        function updateMoistureChart(zoneId) {
            const chartData = moistureHistory[zoneId];
            const ctx = document.getElementById('moistureChart');

            if (!ctx) return;
            
            // Create the chart if it doesn't exist
            if (!moistureChart) {
                ctx.parentElement.innerHTML = '<canvas id="moistureChart" class="w-full h-48 bg-gray-700 rounded-lg"></canvas>';
                const newCtx = document.getElementById('moistureChart');
                
                moistureChart = new Chart(newCtx, {
                    type: 'line',
                    data: {
                        labels: Array(14).fill('').map((_, i) => (i + 1) * 5 + 's ago'),
                        datasets: [{
                            label: 'Soil Moisture (%)',
                            data: chartData,
                            borderColor: '#10b981', // green-500
                            borderWidth: 2,
                            tension: 0.4,
                            pointRadius: 3,
                            fill: true,
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                min: 0,
                                max: 100,
                                ticks: { color: '#9ca3af' },
                                grid: { color: '#374151' }
                            },
                            x: {
                                ticks: { color: '#9ca3af' },
                                grid: { display: false }
                            }
                        },
                        plugins: {
                            legend: { display: false },
                            title: { display: false }
                        }
                    }
                });
            } else {
                // Update existing chart data
                moistureChart.data.datasets[0].data = chartData;
                moistureChart.data.labels = Array(chartData.length).fill('').map((_, i) => (chartData.length - i) * 5 + 's ago').reverse();
                moistureChart.update('none'); // 'none' skips animation for continuous updates
            }
        }


        // --- MODIFIED FUNCTION: startSimulation for Continuous Random Walk ---
        let sensorInterval;
        function startSimulation() {
            // No need for Firebase check in simulation mode
            setInterval(updateWeatherData, 30000);
            updateWeatherData(); 

            sensorInterval = setInterval(async () => {
                // 1. Simulate RTDB Live Feed (ESP32 Raw Data)
                // Random walk for moisture (0-4095). Closer to 4095 is dry (higher number).
                rtdbMoistureRaw += Math.floor(Math.random() * 200) - 100;
                if (isPumpOn) { rtdbMoistureRaw -= 50; } // If pump is on, moisture raw reading decreases (gets wetter)
                rtdbMoistureRaw = Math.min(4095, Math.max(0, rtdbMoistureRaw));
                
                rtdbTemp += Math.random() * 0.5 - 0.25;
                rtdbHumidity += Math.random() * 1 - 0.5;
                rtdbTemp = Math.round(Math.min(40, Math.max(15, rtdbTemp)));
                rtdbHumidity = Math.round(Math.min(90, Math.max(20, rtdbHumidity)));
                
                updateRtdbDisplay(rtdbMoistureRaw, rtdbTemp, rtdbHumidity, isPumpOn ? 'ON' : 'OFF');

                // 2. Simulate Firestore Sensor Data (Processed Data for each Zone)
                for (const zone in sensorData) {
                    let currentData = sensorData[zone];
                    let moisture = currentData.moisture;
                    let temperature = currentData.temperature;
                    let humidity = currentData.humidity;

                    // Apply a random walk to the moisture reading
                    moisture += (Math.random() * 5) - 2.5;
                    
                    // If the pump is ON, moisture increases
                    if (isPumpOn) {
                        moisture += 3; 
                    } 
                    
                    // Apply environmental effect based on current weather
                    if (currentWeatherData.condition === "Sunny" && moisture > 20) moisture -= 0.5;
                    if (currentWeatherData.condition === "Rain Expected" && moisture < 80) moisture += 2;
                    
                    // Keep values within a realistic range
                    moisture = Math.min(100, Math.max(5, moisture));
                    
                    // Apply slight changes to Temp and Humidity for the zone
                    temperature += Math.random() * 0.3 - 0.15;
                    humidity += Math.random() * 0.5 - 0.25;
                    temperature = Math.round(temperature * 10) / 10;
                    humidity = Math.round(humidity * 10) / 10;

                    // Update the local state
                    const sensorDataPoint = {
                        moisture: moisture,
                        temperature: temperature,
                        humidity: humidity,
                        crop: currentData.crop,
                        timestamp: serverTimestamp()
                    };
                    
                    sensorData[zone] = sensorDataPoint;

                    // Update the UI immediately (replaces onSnapshot)
                    updateSensorReadings(zone, sensorDataPoint);
                }

                // 3. Run AI Logic
                simulateAiLogic();
                updateDiagnostics();
                
            }, 5000); // Update every 5 seconds
        }

        // --- MODIFIED FUNCTION: setActiveZone (Ensures chart is updated on switch) ---
        function setActiveZone(zoneId) {
            activeZone = zoneId;
            const data = sensorData[zoneId];
            if (data) {
                const moisture = data.moisture !== undefined ? Math.round(data.moisture) : 0;
                document.getElementById('zoneDetailTitle').textContent = `${data.crop} - Zone ${zoneId.replace('zone', '')}`;
                document.getElementById('moistureValue').textContent = `${moisture}%`;
                document.getElementById('moistureBar').style.width = `${moisture}%`;
                document.getElementById('moistureBar').className = `h-full rounded-full ${moisture > 60 ? 'bg-green-500' : moisture > 30 ? 'bg-yellow-500' : 'bg-red-500'}`;
                document.getElementById('tempValue').textContent = `${data.temperature !== undefined ? Math.round(data.temperature) : '--'}°C`;
                document.getElementById('humidityValue').textContent = `${data.humidity !== undefined ? Math.round(data.humidity) : '--'}%`;
                
                updateMoistureChart(activeZone); // Ensure chart is drawn/updated for the new zone
            }
        }
        
        // ... (The rest of the original code remains the same, except for the mocks above)

        setLogLevel('debug');

        // ... (crops object)

        // The rest of the functions (updatePumpStatus, updateAiMode, updateWeatherData, 
        // updateCropsAndCropsInfo, simulateAiLogic, updateDiagnostics, addMessage, 
        // generateAiResponse, handleChatInput, handleVoiceInput, getDiagnosticsSummary, 
        // getCropInformation, showMessage, updateActiveTab, updateAuthView, 
        // handleEmailSignUp, handleEmailLogin, handleGoogleLogin, handlePasswordReset, 
        // handleSignOut) are kept as in the original code, adapted to use the mock/simulated 
        // functions where Firebase was previously called.

        function updatePumpStatus(isOn) {
            isPumpOn = isOn;
            const pumpStatusText = document.getElementById('pumpStatusText');
            const pumpButton = document.getElementById('pumpControlButton');
            const pumpIndicator = document.getElementById('pumpIndicator');
            const systemStatus = document.getElementById('systemStatus');
            if (isOn) {
                pumpStatusText.textContent = "ON";
                pumpButton.textContent = "STOP PUMP";
                pumpButton.classList.remove('bg-green-600', 'hover:bg-green-700');
                pumpButton.classList.add('bg-red-600', 'hover:bg-red-700');
                pumpIndicator.classList.remove('bg-red-500', 'animate-pulse');
                pumpIndicator.classList.add('bg-green-500');
                systemStatus.textContent = "Watering Active";
            } else {
                pumpStatusText.textContent = "OFF";
                pumpButton.textContent = "START PUMP";
                pumpButton.classList.remove('bg-red-600', 'hover:bg-red-700');
                pumpButton.classList.add('bg-green-600', 'hover:bg-green-700');
                pumpIndicator.classList.remove('bg-green-500');
                pumpIndicator.classList.add('bg-red-500', 'animate-pulse');
                systemStatus.textContent = "All Zones OK";
            }
        }

        function updateAiMode(isAiMode) {
            const aiModeToggle = document.getElementById('aiModeToggle');
            const manualControls = document.getElementById('manualControls');
            aiModeToggle.checked = isAiMode;
            if (isAiMode) {
                manualControls.classList.add('hidden');
                document.getElementById('aiRecommendations').classList.remove('hidden');
            } else {
                manualControls.classList.remove('hidden');
                document.getElementById('aiRecommendations').classList.add('hidden');
            }
        }
        
        function updateWeatherData() {
            const conditions = ["Sunny", "Partly Cloudy", "Rain Expected", "Overcast"];
            const randomCondition = conditions[Math.floor(Math.random() * conditions.length)];
            const randomTemp = Math.floor(Math.random() * 10) + 20;  
            const randomHumid = Math.floor(Math.random() * 20) + 50;  
            currentWeatherData = {
                temperature: randomTemp,
                humidity: randomHumid,
                condition: randomCondition
            };
            document.getElementById('currentWeatherCondition').textContent = currentWeatherData.condition;
            document.getElementById('currentTemperature').textContent = `${currentWeatherData.temperature}°C`;
            document.getElementById('currentHumidity').textContent = `${currentWeatherData.humidity}% Humidity`;
        }
        
        function updateCropsAndCropsInfo() {
            const cropsContainer = document.getElementById('cropsContainer');
            cropsContainer.innerHTML = '';
            
            const aiCrops = {
                'zone1': {
                    photo: 'https://placehold.co/200x200/4c3b53/f3e8ff?text=Lavender',
                    description: 'The AI has identified this zone for drought-tolerant perennials. These plants thrive with minimal watering.'
                },
                'zone2': {
                    photo: 'https://placehold.co/200x200/526d3d/d2ffc0?text=Zoysia+Grass',
                    description: 'Based on soil type and location, the AI suggests Zoysia Grass, which is durable and requires less water.'
                },
                'zone3': {
                    photo: 'https://placehold.co/200x200/c72c1c/fff5e0?text=Tomatoes',
                    description: 'This zone is optimized for vegetables. The AI predicts this area will grow tomatoes which require consistent moisture.'
                },
                'zone4': {
                    photo: 'https://placehold.co/200x200/942b00/d9b48f?text=Apple+Trees',
                    description: 'The AI has determined that this area is perfect for fruit trees due to its deeper soil and sunlight exposure.'
                }
            };

            for (const zone in aiCrops) {
                const crop = aiCrops[zone];
                const cropName = sensorData[zone].crop;
                const cropCard = document.createElement('div');
                cropCard.className = 'bg-gray-800 rounded-xl shadow-inner border border-gray-700 p-4';
                cropCard.innerHTML = `
                    <img src="${crop.photo}" alt="${cropName}" class="rounded-xl w-full h-auto mb-4">
                    <h3 class="text-xl font-bold text-gray-100 mb-2">${cropName}</h3>
                    <p class="text-gray-400 text-sm">${crop.description}</p>
                `;
                cropsContainer.appendChild(cropCard);
            }
        }

        async function simulateAiLogic() {
            // Mock getDoc for settingsSnap
            const settingsSnap = { data: () => ({ aiMode: document.getElementById('aiModeToggle').checked }) }; 
            const aiModeToggle = settingsSnap.data().aiMode;
            
            if (!aiModeToggle) return;
            
            const recommendation = document.getElementById('aiRecommendationMessage');
            const predictionZone = sensorData[activeZone] || sensorData['zone1']; 
            
            if (!predictionZone || predictionZone.moisture === undefined) {
                recommendation.textContent = "**AI Prediction:** \"Waiting for initial sensor data...\"";
                return;
            }

            const moisture = predictionZone.moisture;
            const temperature = predictionZone.temperature;
            const humidity = predictionZone.humidity;
            
            // 1. Get Prediction from the mocked model logic
            const predictionStatus = await aiPredict(moisture, temperature, humidity); 
            const pumpAction = predictionStatus === 1 ? "on" : "off";
            const zoneName = predictionZone.crop;
            
            // 2. Determine AI Message and action
            let message = "";
            let action = false;

            if (currentWeatherData.condition.includes("Rain Expected")) {
                message = `The AI predicts rain. Watering paused to conserve water. Current moisture in ${zoneName}: ${Math.round(moisture)}%.`;
                if (isPumpOn) { await savePumpStatus("off"); action = true; }
            } else if (predictionStatus === 1) {
                message = `Low moisture detected in **${zoneName}** (${Math.round(moisture)}%). AI recommends turning the pump **ON**.`;
                if (!isPumpOn) { await savePumpStatus("on"); action = true; }
            } else {
                message = `Conditions are stable in **${zoneName}** (${Math.round(moisture)}% moisture). AI recommends keeping the pump **OFF**.`;
                if (isPumpOn) { await savePumpStatus("off"); action = true; }
            }

            if(action) {
                 message = `AI has acted: Pump turned **${pumpAction.toUpperCase()}**. ` + message;
            }

            recommendation.textContent = `**AI Prediction:** "${message}"`;
        }
        
        function updateDiagnostics() {
            const diagnosticsContainer = document.getElementById('diagnosticsContainer');
            diagnosticsContainer.innerHTML = ''; 
            
            const diagnostics = [];
            
            for (const zone in sensorData) {
                const data = sensorData[zone];
                 if (data.moisture !== undefined) {
                     if (data.moisture < 20) {
                         diagnostics.push({
                             type: 'Problem',
                             zone: data.crop,
                             message: `Extreme low soil moisture detected (${Math.round(data.moisture)}%). Check the sensor and pump for Zone ${zone.replace('zone', '')}.`,
                             color: 'bg-red-500'
                         });
                     } else if (data.moisture > 80) {
                         diagnostics.push({
                             type: 'Problem',
                             zone: data.crop,
                             message: `High moisture detected (${Math.round(data.moisture)}%). Check for stuck pump or excessive rain for Zone ${zone.replace('zone', '')}.`,
                             color: 'bg-red-500'
                         });
                     }
                 }
            }

            if (diagnostics.length === 0) {
                diagnostics.push({
                    type: 'Status',
                    zone: 'All Zones',
                    message: 'All system parameters are within optimal range. No issues detected.',
                    color: 'bg-green-500'
                });
            }

            diagnostics.forEach(diag => {
                const diagElement = document.createElement('div');
                diagElement.className = `${diag.color} text-white p-4 rounded-lg shadow-md mb-2`;
                diagElement.innerHTML = `<span class="font-bold">${diag.type} (${diag.zone}):</span> ${diag.message}`;
                diagnosticsContainer.appendChild(diagElement);
            });
        }
        
        function addMessage(text, isUser) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageElement = document.createElement('div');
            messageElement.className = `p-3 rounded-lg max-w-[80%] mb-3 ${isUser ? 'bg-blue-600 text-white ml-auto' : 'bg-gray-700 text-gray-200 mr-auto'}`;
            messageElement.textContent = text;
            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;  
        }

        // --- Mock AI Response function (Gemini API bypass) ---
        async function generateAiResponse(userInput) {
            const thinkingMessage = "Hydro-AI is thinking...";
            addMessage(thinkingMessage, false);
            
            const normalizedInput = userInput.toLowerCase().trim();
            
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.removeChild(messagesContainer.lastChild);

            if (normalizedInput.includes("turn pump on") || normalizedInput.includes("start pump")) {
                await savePumpStatus("on");
                addMessage(`System Command: The water pump has been turned ON. (SIMULATION)`, false);
            } 
            else if (normalizedInput.includes("turn pump off") || normalizedInput.includes("stop pump")) {
                await savePumpStatus("off");
                addMessage(`System Command: The water pump has been turned OFF. (SIMULATION)`, false);
            } 
            
            else if (normalizedInput.includes("status") || normalizedInput.includes("readings")) {
                const zoneMatch = normalizedInput.match(/(zone\s*|patch\s*|zone |)(\d)/);
                let zoneIdToReport = activeZone; 

                if (zoneMatch && zoneMatch[2]) {
                    zoneIdToReport = 'zone' + zoneMatch[2];
                } else if (normalizedInput.includes("all")) {
                     addMessage(`Showing general status. Please visit the Diagnostics tab for full details.
- All Zones are monitored by your simulation model.
- Pump Status is currently **${isPumpOn ? 'ON' : 'OFF'}**.`, false);
                     return;
                }

                const data = sensorData[zoneIdToReport];
                
                if (data && data.moisture !== undefined) {
                    addMessage(`Current status for the **${data.crop} (${zoneIdToReport.toUpperCase()})** zone:
- Soil Moisture: ${Math.round(data.moisture)}%
- Temperature: ${Math.round(data.temperature)}°C
- Humidity: ${Math.round(data.humidity)}%`, false);
                } else {
                    addMessage(`I could not retrieve data for **${zoneIdToReport}**. Please ensure that zone is active and data is available.`, false);
                }
            } 
            
            else {
                addMessage(`I am Hydro-AI, the smart irrigation assistant. I can only respond to direct commands about the pump, like "turn pump on," "stop pump," or specific status queries like "status of zone 3."`, false);
            }
        }

        function handleChatInput() {
            const chatInput = document.getElementById('chatInput');
            const userInput = chatInput.value.trim();
            if (userInput) {
                addMessage(userInput, true);
                generateAiResponse(userInput);
                chatInput.value = '';
            }
        }
        
        function handleVoiceInput() {
            addMessage("Voice input is currently not active in this simulation, but it would work using the browser's SpeechRecognition API. What would you like to ask?", false);
        }

        function getDiagnosticsSummary() {
            let problemZones = [];
            for (const zone in sensorData) {
                const data = sensorData[zone];
                if (data.moisture !== undefined && (data.moisture < 20 || data.moisture > 80)) {
                    problemZones.push(data.crop);
                }
            }

            if (problemZones.length > 0) {
                return `There are some issues detected. Low or high moisture levels were found in the following zones: ${problemZones.join(', ')}. Please check the Diagnostics tab for more details.`;
            } else {
                return "All systems are running normally. No issues have been detected.";
            }
        }

        function getCropInformation(cropName) {
            const crop = crops[cropName];
            if (crop) {
                return `Here is some information about ${cropName}: ${crop.description}`;
            } else {
                return `I'm sorry, I don't have information on a crop named ${cropName}. The available crops are Lavender, Zoysia Grass, Tomatoes, and Apple Trees.`;
            }
        }

        function showMessage(msg, type = "info") {
            const messageBox = document.getElementById('statusMessage');
            messageBox.textContent = msg;
            messageBox.className = "p-4 rounded-md mt-4 text-sm font-medium transition-opacity duration-300";
            if (type === "success") {
                messageBox.classList.add('bg-green-500', 'text-white');
            } else if (type === "error") {
                messageBox.classList.add('bg-red-500', 'text-white');
            } else {
                messageBox.classList.add('bg-gray-800', 'text-gray-200');
            }
            messageBox.classList.remove('opacity-0');
            setTimeout(() => {
                messageBox.classList.add('opacity-0');
            }, 5000);
        }
        
        function updateActiveTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('border-green-500', 'text-green-500'));
            
            document.getElementById(`${tabName}-tab`).classList.remove('hidden');
            document.getElementById(`tab-btn-${tabName}`).classList.add('border-green-500', 'text-green-500');
        }

        function updateAuthView(viewName) {
            document.querySelectorAll('.auth-view').forEach(el => el.classList.add('hidden'));
            document.getElementById(viewName).classList.remove('hidden');
        }

        // Mock Auth Handlers
        async function handleEmailSignUp(e) { e.preventDefault(); showMessage("MOCK: Signup successful. Logging you in...", "success"); updateAuthView('login'); }
        async function handleEmailLogin(e) { e.preventDefault(); showMessage("MOCK: Logged in successfully!", "success"); initFirebase(); } 
        async function handleGoogleLogin() { showMessage("MOCK: Logged in with Google successfully!", "success"); initFirebase(); }
        async function handlePasswordReset() { showMessage("MOCK: Password reset email sent.", "success"); }
        async function handleSignOut() { showMessage("MOCK: Signed out successfully.", "success"); document.getElementById('appContainer').classList.add('hidden'); document.getElementById('authContainer').classList.remove('hidden'); updateAuthView('login'); }


        window.onload = function() {
            initFirebase();
            updateActiveTab('dashboard');
            
            if (localStorage.theme === 'light' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: light)').matches)) {
                document.body.setAttribute('data-theme', 'light');
            } else {
                document.body.setAttribute('data-theme', 'dark');
            }

            document.getElementById('mode-toggle').addEventListener('click', () => {
                const isLightMode = document.body.getAttribute('data-theme') === 'light';
                const newTheme = isLightMode ? 'dark' : 'light';
                document.body.setAttribute('data-theme', newTheme);
                localStorage.theme = newTheme;
            });

            document.getElementById('pumpControlButton').addEventListener('click', async () => {
                const pumpStatus = isPumpOn ? "off" : "on";
                await savePumpStatus(pumpStatus);
            });

            document.getElementById('aiModeToggle').addEventListener('change', async (event) => {
                const isAiMode = event.target.checked;
                await saveAiMode(isAiMode);
            });

            document.getElementById('tab-btn-dashboard').addEventListener('click', () => updateActiveTab('dashboard'));
            document.getElementById('tab-btn-assistant').addEventListener('click', () => updateActiveTab('assistant'));
            document.getElementById('tab-btn-diagnostics').addEventListener('click', () => { updateActiveTab('diagnostics'); updateDiagnostics(); });
            document.getElementById('tab-btn-crops').addEventListener('click', () => {
                updateActiveTab('crops');
                updateCropsAndCropsInfo();
            });
            
            document.getElementById('sendButton').addEventListener('click', handleChatInput);
            document.getElementById('voiceButton').addEventListener('click', handleVoiceInput);
            document.getElementById('chatInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleChatInput();
                }
            });

            document.querySelectorAll('.zone-card').forEach(card => {
                card.addEventListener('click', (event) => {
                    const zoneId = event.currentTarget.dataset.zone;
                    setActiveZone(zoneId);
                    document.getElementById('dashboardView').classList.add('hidden');
                    document.getElementById('zoneDetailView').classList.remove('hidden');
                });
            });

            document.getElementById('showDashboard').addEventListener('click', () => {
                document.getElementById('dashboardView').classList.remove('hidden');
                document.getElementById('zoneDetailView').classList.add('hidden');
            });
            
            // Auth listeners
            document.getElementById('login-form').addEventListener('submit', handleEmailLogin);
            document.getElementById('signup-form').addEventListener('submit', handleEmailSignUp);
            document.getElementById('google-login-btn').addEventListener('click', handleGoogleLogin);
            document.getElementById('forgot-password-link').addEventListener('click', handlePasswordReset);
            document.getElementById('logout-btn').addEventListener('click', handleSignOut);
            
            document.getElementById('showSignup').addEventListener('click', (e) => {
                e.preventDefault();
                updateAuthView('signup');
            });
            document.getElementById('showLogin').addEventListener('click', (e) => {
                e.preventDefault();
                updateAuthView('login');
            });

            // Initial chart setup when the detail view might be shown
            updateMoistureChart(activeZone); 
        };
    </script>
    <style>
        /* ... (CSS is unchanged) ... */
        body[data-theme='dark'] {
            --bg-color: #0d111c;
            --text-color: #e2e8f0;
            --card-bg: #161b22;
            --border-color: #24292f;
            --input-bg: #1a1f26;
            --input-border: #30363d;
            --button-bg-primary: #1e7145;
            --button-hover-primary: #15623e;
            --text-secondary: #94a3b8;
        }

        body[data-theme='light'] {
            --bg-color: #ffffff;
            --text-color: #1f2937;
            --card-bg: #f3f4f6;
            --border-color: #d1d5db;
            --input-bg: #e5e7eb;
            --input-border: #9ca3af;
            --button-bg-primary: #10b981;
            --button-hover-primary: #059669;
            --text-secondary: #6b7280;
        }
        
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }
        
        .bg-gray-950, .bg-gray-900, .bg-gray-800, .bg-gray-700 {
            background-color: var(--card-bg);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }
        .text-gray-200, .text-gray-100 {
            color: var(--text-color);
            transition: color 0.3s;
        }
        .text-gray-400, .text-gray-500 {
            color: var(--text-secondary);
            transition: color 0.3s;
        }
        .border-gray-800, .border-gray-700 {
            border-color: var(--border-color);
            transition: border-color 0.3s;
        }
        
        input, .bg-gray-900, .bg-gray-800, .bg-gray-700 {
            background-color: var(--input-bg);
            color: var(--text-color);
            border-color: var(--input-border);
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }

        .bg-green-600 {
            background-color: var(--button-bg-primary);
            transition: background-color 0.3s;
        }
        .hover\:bg-green-700:hover {
            background-color: var(--button-hover-primary);
        }
        .text-green-400 {
            color: var(--button-bg-primary);
        }
        .hover\:text-green-400:hover {
            color: var(--button-hover-primary);
        }

        .mode-toggle-btn {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
            cursor: pointer;
            border-radius: 9999px;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }
        
        .mode-toggle-btn::before {
            content: '';
            position: absolute;
            left: 2px;
            top: 2px;
            width: 22px;
            height: 22px;
            border-radius: 9999px;
            background-color: var(--text-color);
            transition: transform 0.3s ease;
        }
        
        body[data-theme='light'] .mode-toggle-btn::before {
            transform: translateX(22px);
        }

        .mode-toggle-btn .icon {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 18px;
            height: 18px;
            transition: opacity 0.3s ease;
        }
        
        .mode-toggle-btn .moon-icon {
            left: 5px;
            opacity: 1;
        }
        
        body[data-theme='light'] .mode-toggle-btn .moon-icon {
            opacity: 0;
        }
        
        .mode-toggle-btn .sun-icon {
            right: 5px;
            opacity: 0;
        }
        
        body[data-theme='light'] .mode-toggle-btn .sun-icon {
            opacity: 1;
        }
        
        #moistureBar {
            transition: width 0.5s ease-in-out;
        }
        .tab-button {
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease-in-out;
        }
    </style>
</head>
<body data-theme="dark" class="min-h-screen p-4 sm:p-8 flex items-center justify-center">
    
    <div id="authContainer" class="w-full max-w-sm bg-gray-900 rounded-2xl p-6 sm:p-10 shadow-lg border border-gray-800">
        <div id="login" class="auth-view">
            <h2 class="text-3xl font-bold text-center text-gray-100 mb-6">Log In (SIMULATION)</h2>
            <form id="login-form">
                <div class="mb-4">
                    <input type="email" id="loginEmail" placeholder="Email (any value logs in)" class="w-full p-3 rounded-lg bg-gray-800 text-gray-200 border border-gray-700 focus:outline-none focus:ring-2 focus:ring-green-500" required>
                </div>
                <div class="mb-6">
                    <input type="password" id="loginPassword" placeholder="Password (any value logs in)" class="w-full p-3 rounded-lg bg-gray-800 text-gray-200 border border-gray-700 focus:outline-none focus:ring-2 focus:ring-green-500" required>
                </div>
                <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg transition-colors">Log In</button>
            </form>
            <div class="text-center mt-4 text-gray-400 text-sm">
                <a href="#" id="forgot-password-link" class="hover:text-green-400">Forgot Password?</a>
            </div>
            <div class="text-center my-4 text-gray-500">
                OR
            </div>
            <div class="flex flex-col space-y-3">
                <button id="google-login-btn" class="w-full flex items-center justify-center gap-2 bg-gray-800 hover:bg-gray-700 text-white font-bold py-3 rounded-lg transition-colors border border-gray-700">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M22.56 12.28c0-.78-.07-1.54-.2-2.28H12v4.51h6.24c-.28 1.48-1.15 2.76-2.52 3.63v3.29h4.21a11.16 11.16 0 003.57-8.15z" />
                        <path d="M12 23.99c2.83 0 5.19-.93 6.92-2.52l-4.2-3.29c-1.15.77-2.6.99-4.32.99-3.32 0-6.14-2.23-7.14-5.22H.67v3.29a12 12 0 0011.33 8.75z" />
                        <path d="M4.86 14.12c-.5-.14-1.01-.2-1.52-.2-.51 0-1.02.06-1.52.2V10.83H.67a12.02 12.02 0 000 6.34h1.15a8.77 8.77 0 013.04-4.22z" />
                        <path d="M12 4.86c1.69 0 3.2.58 4.39 1.77l3.77-3.77A11.96 11.96 0 0012 .13C5.64.13.38 5.4.38 12h1.15c0-4.6 3.06-8.52 7.29-9.87z" />
                    </svg>
                    <span>Sign in with Google</span>
                </button>
            </div>
            <div class="text-center mt-6 text-gray-400">
                Don't have an account? <a href="#" id="showSignup" class="text-green-400 font-semibold hover:underline">Sign up</a>
            </div>
        </div>
        <div id="signup" class="auth-view hidden">
            <h2 class="text-3xl font-bold text-center text-gray-100 mb-6">Sign Up</h2>
            <form id="signup-form">
                <div class="mb-4">
                    <input type="email" id="signupEmail" placeholder="Email" class="w-full p-3 rounded-lg bg-gray-800 text-gray-200 border border-gray-700 focus:outline-none focus:ring-2 focus:ring-green-500" required>
                </div>
                <div class="mb-6">
                    <input type="password" id="signupPassword" placeholder="Password" class="w-full p-3 rounded-lg bg-gray-800 text-gray-200 border border-gray-700 focus:outline-none focus:ring-2 focus:ring-green-500" required>
                </div>
                <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg transition-colors">Sign Up</button>
            </form>
            <div class="text-center mt-6 text-gray-400">
                Already have an account? <a href="#" id="showLogin" class="text-green-400 font-semibold hover:underline">Log In</a>
            </div>
        </div>
    </div>

    <div id="appContainer" class="hidden w-full max-w-4xl bg-gray-900 rounded-2xl p-6 sm:p-10 shadow-lg border border-gray-800">
        <header class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-8">
            <div class="flex items-center gap-4 mb-4 sm:mb-0">
                <div class="p-2 bg-green-500 rounded-full">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v18M12 3c-1.105 0-2 .895-2 2s.895 2 2 2h0c1.105 0 2-.895 2-2s-.895-2-2-2zM4 14h16m-8 0a4 4 0 100-8 4 4 0 000 8z"></path>
                    </svg>
                </div>
                <h1 class="text-3xl sm:text-4xl font-bold text-gray-100">Hydro-AI (SIMULATION)</h1>
            </div>
            <div class="flex items-center gap-4">
                <label id="mode-toggle" class="mode-toggle-btn">
                    <svg class="moon-icon icon" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M21.73 17.51a1.2 1.2 0 01-1.35.34A9.91 9.91 0 0013.06 4.3a1.2 1.2 0 01-1.1-2.12c-.22-.38-.72-.51-1.12-.32A10.87 10.87 0 002.5 12c0 5.92 4.8 10.74 10.71 10.74a10.87 10.87 0 008.85-4.54 1.2 1.2 0 01.37-1.07zm-2.88-2.67a8.55 8.55 0 01-6.15 2.53A8.53 8.53 0 015.65 12a8.55 8.55 0 016.15-2.52 8.53 8.53 0 017.05 4.7z"></path>
                    </svg>
                    <svg class="sun-icon icon" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 4.5a.9.9 0 00-1 0 .9.9 0 00-.5 1.5l1.62 1.62a.9.9 0 001.28 0l1.62-1.62a.9.9 0 00-.5-1.5zM3 12a.9.9 0 001.8 0 .9.9 0 00-1.8 0zM21 12a.9.9 0 001.8 0 .9.9 0 00-1.8 0zM12 21a.9.9 0 001-1.5l-1.62-1.62a.9.9 0 00-1.28 0L9.5 19.5a.9.9 0 00.5 1.5zM5.5 5.5a.9.9 0 00-1.27 0 .9.9 0 000 1.28l1.62 1.62a.9.9 0 001.28 0l1.62-1.62a.9.9 0 00-1.28 0zM18.5 18.5a.9.9 0 00-1.27 0 .9.9 0 000 1.28l1.62 1.62a.9.9 0 001.28 0l1.62-1.62a.9.9 0 00-1.28 0zM18.5 5.5a.9.9 0 00-1.27 0 .9.9 0 000 1.28l1.62 1.62a.9.9 0 001.28 0l1.62-1.62a.9.9 0 00-1.28 0zM5.5 18.5a.9.9 0 00-1.27 0 .9.9 0 000 1.28l1.62 1.62a.9.9 0 001.28 0l1.62-1.62a.9.9 0 00-1.28 0zM12 10.5a1.5 1.5 0 100 3 1.5 1.5 0 000-3z"></path>
                    </svg>
                </label>
                <div class="flex flex-col items-start sm:items-end text-sm text-gray-400">
                    <span id="userIdDisplay" class="truncate">User: Loading...</span>
                    <button id="logout-btn" class="mt-1 text-red-400 hover:text-red-500 font-semibold">Log Out</button>
                </div>
            </div>
        </header>

        <div id="statusMessage" class="opacity-0 transition-opacity duration-300"></div>

        <div class="flex border-b border-gray-700 mb-6">
            <button id="tab-btn-dashboard" class="tab-button flex-1 text-center py-3 text-lg font-semibold text-gray-400 hover:text-gray-200 hover:border-gray-500">Dashboard</button>
            <button id="tab-btn-assistant" class="tab-button flex-1 text-center py-3 text-lg font-semibold text-gray-400 hover:text-gray-200 hover:border-gray-500">AI Assistant</button>
            <button id="tab-btn-diagnostics" class="tab-button flex-1 text-center py-3 text-lg font-semibold text-gray-400 hover:text-gray-200 hover:border-gray-500">Diagnostics</button>
            <button id="tab-btn-crops" class="tab-button flex-1 text-center py-3 text-lg font-semibold text-gray-400 hover:text-gray-200 hover:border-gray-500">What's Growing?</button>
        </div>

        <div id="dashboard-tab" class="tab-content view">
            <div id="dashboardView" class="view">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                    <div class="bg-gray-800 p-6 rounded-xl shadow-inner border border-gray-700">
                        <h3 class="text-sm text-gray-400 mb-2">System Status</h3>
                        <div class="flex items-center justify-between">
                            <span id="systemStatus" class="text-xl font-bold text-green-400">All Zones OK</span>
                            <div id="pumpIndicator" class="w-4 h-4 rounded-full bg-red-500 animate-pulse"></div>
                        </div>
                    </div>
                    <div class="bg-gray-800 p-6 rounded-xl shadow-inner border border-gray-700">
                        <h3 class="text-sm text-gray-400 mb-2">Current Weather</h3>
                        <div class="flex items-center gap-2">
                            <svg class="w-8 h-8 text-yellow-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364-6.364l-.707-.707M6.343 17.657l-.707.707M16.364 6.364l.707-.707M6.343 6.343l.707-.707M12 8a4 4 0 100 8 4 4 0 000-8z"></path>
                            </svg>
                            <div>
                                <span id="currentWeatherCondition" class="text-xl font-bold text-gray-100">Loading...</span>
                                <span class="text-sm text-gray-400"><span id="currentTemperature"></span>, <span id="currentHumidity"></span></span>
                            </div>
                        </div>
                    </div>
                    <div class="bg-gray-800 p-6 rounded-xl shadow-inner border border-gray-700">
                        <h3 class="text-sm text-gray-400 mb-2">Next Watering</h3>
                        <p class="text-lg font-bold text-gray-100">Tomorrow at 6:00 AM</p>
                        <p class="text-xs text-gray-500">Scheduled by AI</p>
                    </div>
                </div>

                <div class="bg-gray-800 p-6 rounded-xl shadow-inner border border-green-500 mb-8">
                    <h3 class="text-xl font-bold text-green-400 mb-4">⭐ SIMULATED ESP32 RAW Live Feed ⭐</h3>
                    <div class="space-y-2 text-gray-400">
                        <p>Soil Moisture: <span id="soil" class="text-gray-100 font-bold">...Loading</span></p>
                        <p>Temperature: <span id="temperature" class="text-gray-100 font-bold">...Loading</span></p>
                        <p>Humidity: <span id="humidity" class="text-gray-100 font-bold">...Loading</span></p>
                        <p>Pump Status: <span id="status" class="text-gray-100 font-bold">...Loading</span></p>
                    </div>
                </div>
                <div class="bg-gray-800 p-6 rounded-xl shadow-inner border border-gray-700 mb-8">
                    <h3 class="text-lg font-semibold text-gray-100 mb-4">Garden Zone</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="zone-card relative bg-gray-700 rounded-lg p-6 text-center cursor-pointer hover:bg-gray-600 transition-colors" data-zone="zone1" id="zone1-moisture-card">
                            <span class="status-indicator absolute top-2 right-2 w-3 h-3 rounded-full bg-green-500 animate-pulse"></span>
                            <img id="zone1-live-image" class="w-full h-auto rounded-lg mb-2" src="https://placehold.co/200x150/52382f/ffffff?text=Flower+Bed" alt="Live soil image">
                            <h4 class="text-base font-semibold text-gray-100">Flower Bed</h4>
                            <p class="text-sm text-gray-400">Moisture: <span class="moisture-value">75%</span></p>
                        </div>
                        <div class="zone-card relative bg-gray-700 rounded-lg p-6 text-center cursor-pointer hover:bg-gray-600 transition-colors" data-zone="zone2" id="zone2-moisture-card">
                            <span class="status-indicator absolute top-2 right-2 w-3 h-3 rounded-full bg-yellow-500"></span>
                            <img id="zone2-live-image" class="w-full h-auto rounded-lg mb-2" src="https://placehold.co/200x150/474c3e/ffffff?text=Lawn" alt="Live soil image">
                            <h4 class="text-base font-semibold text-gray-100">Lawn</h4>
                            <p class="text-sm text-gray-400">Moisture: <span class="moisture-value">40%</span></p>
                        </div>
                        <div class="zone-card relative bg-gray-700 rounded-lg p-6 text-center cursor-pointer hover:bg-gray-600 transition-colors" data-zone="zone3" id="zone3-moisture-card">
                            <span class="status-indicator absolute top-2 right-2 w-3 h-3 rounded-full bg-red-500"></span>
                            <img id="zone3-live-image" class="w-full h-auto rounded-lg mb-2" src="https://placehold.co/200x150/453b3d/ffffff?text=Vegetable+Patch" alt="Live soil image">
                            <h4 class="text-base font-semibold text-gray-100">Vegetable Patch</h4>
                            <p class="text-sm text-gray-400">Moisture: <span class="moisture-value">22%</span></p>
                        </div>
                        <div class="zone-card relative bg-gray-700 rounded-lg p-6 text-center cursor-pointer hover:bg-gray-600 transition-colors" data-zone="zone4" id="zone4-moisture-card">
                            <span class="status-indicator absolute top-2 right-2 w-3 h-3 rounded-full bg-green-500"></span>
                            <img id="zone4-live-image" class="w-full h-auto rounded-lg mb-2" src="https://placehold.co/200x150/615a45/ffffff?text=Fruit+Trees" alt="Live soil image">
                            <h4 class="text-base font-semibold text-gray-100">Fruit Trees</h4>
                            <p class="text-sm text-gray-400">Moisture: <span class="moisture-value">68%</span></p>
                        </div>
                    </div>
                </div>

                <div class="bg-gray-800 p-6 rounded-xl shadow-inner border border-gray-700">
                    <h3 class="text-lg font-semibold text-gray-100 mb-4">AI & System Control</h3>
                    
                    <div class="flex items-center justify-between mb-4">
                        <span class="text-gray-400">Enable AI-Powered Mode (SIMULATION)</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="aiModeToggle" class="sr-only peer" checked>
                            <div class="w-11 h-6 bg-gray-600 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-green-400 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                        </label>
                    </div>
                    
                    <div id="aiRecommendations">
                        <p class="text-gray-400 mb-4">The AI is actively monitoring conditions and optimizing your schedule.</p>
                        <div class="p-4 bg-gray-700 rounded-lg">
                            <p id="aiRecommendationMessage" class="text-sm text-gray-200">
                                **AI Prediction:** "Loading initial data..."
                            </p>
                        </div>
                    </div>

                    <div id="manualControls" class="hidden">
                        <p class="text-gray-400 mb-4">You have disabled AI mode. Manual controls are now active.</p>
                        <button id="pumpControlButton" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-xl transition-colors">
                            START PUMP
                        </button>
                        <p class="text-center text-gray-500 text-xs mt-2">Current pump status: <span id="pumpStatusText">OFF</span></p>
                    </div>
                </div>
            </div>

            <div id="zoneDetailView" class="view hidden">
                <button id="showDashboard" class="text-gray-400 hover:text-gray-200 mb-6 flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                    Back to Dashboard
                </button>
                <h2 id="zoneDetailTitle" class="text-3xl font-bold text-gray-100 mb-6">Flower Bed - Zone 1</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                    <div class="bg-gray-800 p-6 rounded-xl shadow-inner border border-gray-700">
                        <h3 class="text-sm text-gray-400 mb-2">Soil Moisture</h3>
                        <div class="flex items-end gap-2 mb-2">
                            <span id="moistureValue" class="text-4xl font-extrabold text-green-400">75%</span>
                        </div>
                        <div class="w-full bg-gray-700 h-2 rounded-full overflow-hidden">
                            <div id="moistureBar" class="h-full rounded-full" style="width: 75%;"></div>
                        </div>
                    </div>
                    
                    <div class="bg-gray-800 p-6 rounded-xl shadow-inner border border-gray-700">
                        <h3 class="text-sm text-gray-400 mb-2">Temperature</h3>
                        <span id="tempValue" class="text-4xl font-extrabold text-gray-100">25°C</span>
                        <p class="text-sm text-gray-500 mt-1">Optimal for this crop</p>
                    </div>
                    
                    <div class="bg-gray-800 p-6 rounded-xl shadow-inner border border-gray-700">
                        <h3 class="text-sm text-gray-400 mb-2">Humidity</h3>
                        <span id="humidityValue" class="text-4xl font-extrabold text-gray-100">65%</span>
                        <p class="text-sm text-gray-500 mt-1">Air humidity</p>
                    </div>
                </div>
                
                <div class="bg-gray-800 p-6 rounded-xl shadow-inner border border-gray-700">
                    <h3 class="text-lg font-semibold text-gray-100 mb-4">Moisture Trends (Past 7 Days)</h3>
                    <div class="w-full h-48 bg-gray-700 rounded-lg flex items-center justify-center text-gray-500 italic">
                        <canvas id="moistureChart" class="w-full h-full"></canvas>
                    </div>
                    </div>
            </div>
        </div>
        
        <div id="assistant-tab" class="tab-content hidden">
            <div class="flex flex-col h-[60vh] max-h-[60vh] bg-gray-800 rounded-xl shadow-inner border border-gray-700">
                <div id="chatMessages" class="flex-1 p-6 overflow-y-auto flex flex-col space-y-3">
                    <div class="p-3 rounded-lg max-w-[80%] bg-gray-700 text-gray-200 mr-auto">
                        Hello! I am Hydro-AI, your smart irrigation assistant. How can I help? (Try: "turn pump on" or "status of zone 3")
                    </div>
                </div>
                <div class="p-4 border-t border-gray-700 flex items-center gap-2">
                    <input id="chatInput" type="text" placeholder="Ask about soil moisture, weather, or pump status..." class="flex-1 bg-gray-900 text-white rounded-full px-4 py-2 focus:outline-none focus:ring-2 focus:ring-green-500">
                    <button id="voiceButton" class="bg-gray-700 hover:bg-gray-600 rounded-full p-2 transition-colors">
                        <svg class="w-6 h-6 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a4 4 0 11-8 0 4 4 0 018 0z"></path>
                        </svg>
                    </button>
                    <button id="sendButton" class="bg-green-600 hover:bg-green-700 text-white rounded-full p-2 transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M12 5l7 7-7 7"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
        
        <div id="diagnostics-tab" class="tab-content hidden">
            <h3 class="text-2xl font-bold text-gray-100 mb-4">System Health & Diagnostics</h3>
            <p class="text-sm text-gray-400 mb-6">Hydro-AI continuously monitors all components and provides real-time health checks and suggestions.</p>
            <div id="diagnosticsContainer" class="flex flex-col space-y-4">
                </div>
        </div>

        <div id="crops-tab" class="tab-content hidden">
            <h3 class="text-2xl font-bold text-gray-100 mb-4">What's Growing?</h3>
            <p class="text-sm text-gray-400 mb-6">Here are the crops in your garden and their specific care needs.</p>
            <div id="cropsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                </div>
        </div>
        
    </div>
</body>
</html>
